define(['exports', 'module', './settings'], function (exports, module, _settings) {
  'use strict';

  module.exports = {
    cubic: svgCubicBezierLinkPath,
    linear: svgLinearLinkPath
  };
  var X = 0;
  var Y = 1;
  var FROM = 0;
  var TO = 1;

  var DEFAULT_STUBS = [1, -1];

  // Length of a horizontal link stub that helps visualizing where a link is attached
  var baseStubLength = _settings.pathing.stubLength;
  var baseArrowHeadLength = _settings.pathing.arrowHeadLength;
  var baseCurvePadding = _settings.pathing.curvePadding;

  var round = Math.round;
  var abs = Math.abs;
  var min = Math.min;
  var max = Math.max;

  function svgLinearLinkPath(from, to, stubs, zoomFactor, boxes, showArrow) {
    var fromX = round(from[X]),
        fromY = round(from[Y]),
        toX = round(to[X]),
        toY = round(to[Y]),
        stubLength = baseStubLength * (zoomFactor || 1);

    var path = ['M', fromX, ',', fromY];
    path.push('H', fromX + stubs[FROM] * stubLength / 2);
    path.push('L', toX + stubs[TO] * stubLength / 2, ',', toY);
    path.push('H', toX);
    return path.join('');
  }

  ////////////////////////////////////////////////////////////////////////////////

  /*
   * Generate a smooth path between:
   *  - outbound port of a vertex and inbound port of another vertex
   *  - a port and an edge node
   *
   * Try to circumvent start and end box so that connections are obvious.
   */
  function svgCubicBezierLinkPath(from, to, zoomFactor, boxes, showArrow) {
    var stubs = arguments.length <= 5 || arguments[5] === undefined ? DEFAULT_STUBS : arguments[5];

    var arrowHeadLength = baseArrowHeadLength * (zoomFactor || 1);
    var stubLength = baseStubLength * (zoomFactor || 1);
    var safeDistanceX = 2 * stubLength;
    var safeDistanceY = 3 * stubLength;

    var distanceX = abs(from[X] - to[X]);
    var distanceY = abs(from[Y] - to[Y]);
    if (distanceX < safeDistanceX && distanceY < safeDistanceY) {
      return svgLinearLinkPath(from, to, stubs);
    }

    var params = initializeParameters(from, to, boxes, stubs, stubLength, baseCurvePadding);

    // Current path and position:
    var x = params.x0;
    var y = params.y0;

    var path = [];
    path.push('M', x, ',', y);
    var yDominates = startSegment();
    endSegment(yDominates);
    return path.join('');

    //////////////////////////////////////////////////////////////////////////////

    function startSegment() {
      if (params.reverse) {
        arrowHead();
      }
      horizontal(x + params.stub0 * stubLength);
      if (params.stub0 < 0) {
        return circumventBox0();
      }
      return false;
    }

    //////////////////////////////////////////////////////////////////////////////

    function endSegment(useBezierY) {
      if (params.stubN > 0 && params.boxN) {
        circumventBoxN(useBezierY);
      } else {
        cubic(params.xN + params.stubN * params.stubLength, params.yN);
      }

      horizontal(params.xN);
      if (!params.reverse) {
        arrowHead();
      }
    }

    //////////////////////////////////////////////////////////////////////////////

    function cubic(toX, toY) {
      var middleX = x + (toX - x) / 2;
      path.push('C', middleX, ',', y, ' ', middleX, ',', toY, ' ', toX, ',', toY);
      x = toX;
      y = toY;
    }

    //////////////////////////////////////////////////////////////////////////////

    function cubicY(toX, toY) {
      var middleY = y + (toY - y) / 2;
      path.push('C', x, ',', middleY, ' ', toX, ',', middleY, ' ', toX, ',', toY);
      x = toX;
      y = toY;
    }

    //////////////////////////////////////////////////////////////////////////////

    function horizontal(xAbs) {
      x = xAbs;
      path.push('H', x);
    }

    //////////////////////////////////////////////////////////////////////////////

    function arc90(xSgn, ySgn, sweep) {
      x += xSgn * params.curvePadding;
      y += ySgn * params.curvePadding;
      path.push('A', params.curvePadding, ',', params.curvePadding, ' 0 0,', sweep, ' ', x, ',', y);
    }

    //////////////////////////////////////////////////////////////////////////////

    function vertical(yAbs) {
      y = yAbs;
      path.push('V', yAbs);
    }

    //////////////////////////////////////////////////////////////////////////////

    function arrowHead() {
      if (!showArrow) {
        return;
      }

      var ax = x - stubLength - arrowHeadLength,
          ay = y;
      path.push('M', ax, ',', ay - arrowHeadLength, 'L', ax + stubLength / 2, ',', ay, 'L', ax, ',', ay + arrowHeadLength, 'L', ax + arrowHeadLength, ',', ay, 'L', ax, ',', ay - arrowHeadLength, 'M', x, ',', y);
    }

    //////////////////////////////////////////////////////////////////////////////

    function circumventBox0() {
      var xN = params.xN;
      var yN = params.yN;
      var box0 = params.box0;
      var boxN = params.boxN;
      var curvePadding = params.curvePadding;

      var yDir = calculateStartDirectionY();
      var sweep = yDir === 1 ? 0 : 1;

      circumventY();
      return circumventX();

      function circumventY() {
        // Arc and go to bottom/top:
        arc90(-1, yDir, sweep);
        if (yDir === 1) {
          vertical(max(box0.bottom, y + curvePadding));
        } else {
          vertical(min(box0.top, y - curvePadding));
        }
      }

      function circumventX() {
        // Cling to bottom/top edge as far as needed:
        if (yN * yDir < y * yDir || abs(y - yN) * 4 < abs(x - xN)) {
          arc90(1, yDir, sweep);
          if (yN * yDir < y * yDir) {
            horizontal(max(x, min(box0.right, xN - 2 * curvePadding)));
          }
          return false;
        }
        if (!boxN && xN > box0.left) {
          arc90(1, yDir, sweep);
          return false;
        }
        return true;
      }

      function calculateStartDirectionY() {
        // down: 1, up: -1
        if (!boxN && yN > y || boxN && boxN.top > box0.bottom) {
          // The entire dest is below this box: always go downwards
          return 1;
        }
        if (!boxN && yN < y || boxN && boxN.bottom < box0.top) {
          // The entire dest is above this box: always go upwards
          return -1;
        }
        // Shortest path to edge of this box
        return abs(box0.top - y) < abs(y - box0.bottom) ? -1 : 1;
      }
    }

    //////////////////////////////////////////////////////////////////////////////

    function circumventBoxN(useBezierY) {
      var boxN = params.boxN;
      var yN = params.yN;
      var curvePadding = params.curvePadding;

      // Draw line to nearest corner of boxN:
      var yDir, yEdge, xEdge, sweep;
      if (abs(boxN.top - y) + (y < yN ? -1 : 0) < abs(y - boxN.bottom)) {
        yDir = 1;
        yEdge = min(boxN.top - curvePadding, yN - 2 * curvePadding);
        sweep = 1;
        xEdge = yEdge > y ? boxN.right : boxN.left;
      } else {
        yDir = -1;
        yEdge = max(boxN.bottom + curvePadding, yN + 2 * curvePadding);
        sweep = 0;
        xEdge = yEdge < y ? boxN.right : boxN.left;
      }

      if (useBezierY) {
        cubicY(boxN.right + curvePadding, yEdge);
      } else {
        cubic(max(xEdge, x + curvePadding), yEdge);
        // Stick to bottom/top edge as far as needed:
        horizontal(boxN.right);
        arc90(1, yDir, sweep);
      }
      // turn towards port
      vertical(yN - yDir * curvePadding);
      arc90(-1, yDir, sweep);
    }
  }

  ////////////////////////////////////////////////////////////////////////////////

  function initializeParameters(from, to, boxes, stubs, stubLength, curvePadding) {
    var params = { stubLength: stubLength, curvePadding: curvePadding };

    var fromLeft = from[X],
        fromTop = from[Y];
    var toLeft = to[X],
        toTop = to[Y];
    var fromBox = boxes[FROM],
        toBox = boxes[TO];
    var fromStub = stubs[FROM],
        toStub = stubs[TO];

    var safeBoxDistance = 3 * stubLength;
    var minStubLength = 3;
    var minCurvePadding = 1;

    var yRatio = 1;
    if (toBox) {
      var boxDeltaY = abs(toTop > fromTop ? fromBox.bottom - toBox.top : toBox.bottom - fromBox.top);
      if (boxDeltaY < safeBoxDistance) {
        yRatio = boxDeltaY / safeBoxDistance;
        params.curvePadding = max(minStubLength, max(1, round(yRatio * curvePadding)));
      }
    }

    var deltaX = abs(fromLeft - toLeft);
    if (deltaX < safeBoxDistance && yRatio < 1) {
      var xRatio = deltaX / safeBoxDistance;
      params.stubLength = max(minStubLength, round(xRatio * stubLength));
      params.curvePadding = max(minCurvePadding, round(xRatio * curvePadding));
    }

    // Simplify by always drawing a path from left to right:
    params.reverse = fromLeft + fromStub * stubLength > toLeft + toStub * stubLength;
    if (params.reverse) {
      params.x0 = round(toLeft);
      params.xN = round(fromLeft);
      params.y0 = round(toTop);
      params.yN = round(fromTop);
      params.stub0 = toStub;
      params.stubN = fromStub;
      params.box0 = toBox;
      params.boxN = fromBox;
    } else {
      params.x0 = round(fromLeft);
      params.xN = round(toLeft);
      params.y0 = round(fromTop);
      params.yN = round(toTop);
      params.stub0 = fromStub;
      params.stubN = toStub;
      params.box0 = fromBox;
      params.boxN = toBox;
    }

    return params;
  }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3BhdGhpbmcuanN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OzttQkFFZTtBQUNiLFNBQUssRUFBRSxzQkFBc0I7QUFDN0IsVUFBTSxFQUFFLGlCQUFpQjtHQUMxQjtNQUVPLENBQUMsR0FBVSxDQUFDO01BQVQsQ0FBQyxHQUFVLENBQUM7TUFDZixJQUFJLEdBQVcsQ0FBQztNQUFWLEVBQUUsR0FBVSxDQUFDOztBQUMzQixNQUFNLGFBQWEsR0FBRyxDQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBRSxDQUFDOzs7QUFHaEMsTUFBTSxjQUFjLEdBQUcsVUFBUyxPQUFPLENBQUMsVUFBVSxDQUFDO0FBQ25ELE1BQU0sbUJBQW1CLEdBQUcsVUFBUyxPQUFPLENBQUMsZUFBZSxDQUFDO0FBQzdELE1BQU0sZ0JBQWdCLEdBQUcsVUFBUyxPQUFPLENBQUMsWUFBWSxDQUFDOztNQUUvQyxLQUFLLEdBQW9CLElBQUksQ0FBN0IsS0FBSztNQUFFLEdBQUcsR0FBZSxJQUFJLENBQXRCLEdBQUc7TUFBRSxHQUFHLEdBQVUsSUFBSSxDQUFqQixHQUFHO01BQUUsR0FBRyxHQUFLLElBQUksQ0FBWixHQUFHOztBQUc1QixXQUFTLGlCQUFpQixDQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFHO0FBQzFFLFFBQU0sS0FBSyxHQUFHLEtBQUssQ0FBRSxJQUFJLENBQUUsQ0FBQyxDQUFFLENBQUU7UUFBRSxLQUFLLEdBQUcsS0FBSyxDQUFFLElBQUksQ0FBRSxDQUFDLENBQUUsQ0FBRTtRQUM1RCxHQUFHLEdBQUcsS0FBSyxDQUFFLEVBQUUsQ0FBRSxDQUFDLENBQUUsQ0FBRTtRQUFFLEdBQUcsR0FBRyxLQUFLLENBQUUsRUFBRSxDQUFFLENBQUMsQ0FBRSxDQUFFO1FBQzlDLFVBQVUsR0FBRyxjQUFjLElBQUssVUFBVSxJQUFJLENBQUMsQ0FBQSxDQUFHOztBQUVsRCxRQUFNLElB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QUFDO0tBQ3ZCLE1BQ0k7QUFDSCxZQUFNLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBRSxRQUFRLENBQUUsQ0FBQztBQUM5QixZQUFNLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBRSxNQUFNLENBQUUsQ0FBQztBQUM1QixZQUFNLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBRSxPQUFPLENBQUUsQ0FBQztBQUM3QixZQUFNLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBRSxLQUFLLENBQUUsQ0FBQztBQUMzQixZQUFNLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQztBQUN4QixZQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztBQUN0QixZQUFNLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztBQUN0QixZQUFNLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztLQUNyQjs7QUFFRCxXQUFPLE1BQU0sQ0FBQztHQUNmIiwiZmlsZSI6InBhdGhpbmcuanMiLCJzb3VyY2VSb290Ijoic3JjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc2V0dGluZ3MgZnJvbSAnLi9zZXR0aW5ncyc7XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgY3ViaWM6IHN2Z0N1YmljQmV6aWVyTGlua1BhdGgsXG4gIGxpbmVhcjogc3ZnTGluZWFyTGlua1BhdGhcbn07XG5cbmNvbnN0IFsgWCwgWSBdID0gWyAwLCAxIF07XG5jb25zdCBbIEZST00sIFRPIF0gPSBbIDAsIDEgXTtcbmNvbnN0IERFRkFVTFRfU1RVQlMgPSBbIDEsIC0xIF07XG5cbi8vIExlbmd0aCBvZiBhIGhvcml6b250YWwgbGluayBzdHViIHRoYXQgaGVscHMgdmlzdWFsaXppbmcgd2hlcmUgYSBsaW5rIGlzIGF0dGFjaGVkXG5jb25zdCBiYXNlU3R1Ykxlbmd0aCA9IHNldHRpbmdzLnBhdGhpbmcuc3R1Ykxlbmd0aDtcbmNvbnN0IGJhc2VBcnJvd0hlYWRMZW5ndGggPSBzZXR0aW5ncy5wYXRoaW5nLmFycm93SGVhZExlbmd0aDtcbmNvbnN0IGJhc2VDdXJ2ZVBhZGRpbmcgPSBzZXR0aW5ncy5wYXRoaW5nLmN1cnZlUGFkZGluZztcblxuY29uc3QgeyByb3VuZCwgYWJzLCBtaW4sIG1heCB9ID0gTWF0aDtcblxuXG5mdW5jdGlvbiBzdmdMaW5lYXJMaW5rUGF0aCggZnJvbSwgdG8sIHN0dWJzLCB6b29tRmFjdG9yLCBib3hlcywgc2hvd0Fycm93ICkge1xuICBjb25zdCBmcm9tWCA9IHJvdW5kKCBmcm9tWyBYIF0gKSwgZnJvbVkgPSByb3VuZCggZnJvbVsgWSBdICksXG4gIHRvWCA9IHJvdW5kKCB0b1sgWCBdICksIHRvWSA9IHJvdW5kKCB0b1sgWSBdICksXG4gIHN0dWJMZW5ndGggPSBiYXNlU3R1Ykxlbmd0aCAqICggem9vbUZhY3RvciB8fCAxICk7XG5cbiAgY29uc3QgcGF0aCA9IFsgJ00nLCBmcm9tWCwgJywnLCBmcm9tWSBdO1xuICBwYXRoLnB1c2goICdIJywgZnJvbVggKyBzdHVic1sgRlJPTSBdICogc3R1Ykxlbmd0aCAvIDIgKTtcbiAgcGF0aC5wdXNoKCAnTCcsIHRvWCArIHN0dWJzWyBUTyBdICogc3R1Ykxlbmd0aCAvIDIsICcsJywgdG9ZICk7XG4gIHBhdGgucHVzaCggJ0gnLCB0b1ggKTtcbiAgcmV0dXJuIHBhdGguam9pbiggJycgKTtcbn1cblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuLypcbiAqIEdlbmVyYXRlIGEgc21vb3RoIHBhdGggYmV0d2VlbjpcbiAqICAtIG91dGJvdW5kIHBvcnQgb2YgYSB2ZXJ0ZXggYW5kIGluYm91bmQgcG9ydCBvZiBhbm90aGVyIHZlcnRleFxuICogIC0gYSBwb3J0IGFuZCBhbiBlZGdlIG5vZGVcbiAqXG4gKiBUcnkgdG8gY2lyY3VtdmVudCBzdGFydCBhbmQgZW5kIGJveCBzbyB0aGF0IGNvbm5lY3Rpb25zIGFyZSBvYnZpb3VzLlxuICovXG5mdW5jdGlvbiBzdmdDdWJpY0JlemllckxpbmtQYXRoKFxuICBmcm9tLCB0bywgem9vbUZhY3RvciwgYm94ZXMsIHNob3dBcnJvdywgc3R1YnMgPSBERUZBVUxUX1NUVUJTXG4pIHtcblxuICBjb25zdCBhcnJvd0hlYWRMZW5ndGggPSBiYXNlQXJyb3dIZWFkTGVuZ3RoICogKCB6b29tRmFjdG9yIHx8IDEgKTtcbiAgY29uc3Qgc3R1Ykxlbmd0aCA9IGJhc2VTdHViTGVuZ3RoICogKCB6b29tRmFjdG9yIHx8IDEgKTtcbiAgY29uc3Qgc2FmZURpc3RhbmNlWCA9IDIgKiBzdHViTGVuZ3RoO1xuICBjb25zdCBzYWZlRGlzdGFuY2VZID0gMyAqIHN0dWJMZW5ndGg7XG5cbiAgY29uc3QgZGlzdGFuY2VYID0gYWJzKCBmcm9tWyBYIF0gLSB0b1sgWCBdICk7XG4gIGNvbnN0IGRpc3RhbmNlWSA9IGFicyggZnJvbVsgWSBdIC0gdG9bIFkgXSApO1xuICBpZiggZGlzdGFuY2VYIDwgc2FmZURpc3RhbmNlWCAmJiBkaXN0YW5jZVkgPCBzYWZlRGlzdGFuY2VZICkge1xuICAgIHJldHVybiBzdmdMaW5lYXJMaW5rUGF0aCggZnJvbSwgdG8sIHN0dWJzICk7XG4gIH1cblxuICBjb25zdCBwYXJhbXMgPSBpbml0aWFsaXplUGFyYW1ldGVycyhcbiAgICBmcm9tLCB0bywgYm94ZXMsIHN0dWJzLCBzdHViTGVuZ3RoLCBiYXNlQ3VydmVQYWRkaW5nXG4gICk7XG5cbiAgLy8gQ3VycmVudCBwYXRoIGFuZCBwb3NpdGlvbjpcbiAgdmFyIFsgeCwgeSBdID0gWyBwYXJhbXMueDAsIHBhcmFtcy55MCBdO1xuXG4gIGNvbnN0IHBhdGggPSBbXTtcbiAgcGF0aC5wdXNoKCAnTScsIHgsICcsJywgeSApO1xuICBjb25zdCB5RG9taW5hdGVzID0gc3RhcnRTZWdtZW50KCk7XG4gIGVuZFNlZ21lbnQoIHlEb21pbmF0ZXMgKTtcbiAgcmV0dXJuIHBhdGguam9pbiggJycgKTtcblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBmdW5jdGlvbiBzdGFydFNlZ21lbnQoKSB7XG4gICAgaWYoIHBhcmFtcy5yZXZlcnNlICkge1xuICAgICAgYXJyb3dIZWFkKCk7XG4gICAgfVxuICAgIGhvcml6b250YWwoIHggKyBwYXJhbXMuc3R1YjAgKiBzdHViTGVuZ3RoICk7XG4gICAgaWYoIHBhcmFtcy5zdHViMCA8IDAgKSB7XG4gICAgICByZXR1cm4gY2lyY3VtdmVudEJveDAoKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgZnVuY3Rpb24gZW5kU2VnbWVudCggdXNlQmV6aWVyWSApIHtcbiAgICBpZiggcGFyYW1zLnN0dWJOID4gMCAmJiBwYXJhbXMuYm94TiApIHtcbiAgICAgIGNpcmN1bXZlbnRCb3hOKCB1c2VCZXppZXJZICk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgY3ViaWMoIHBhcmFtcy54TiArIHBhcmFtcy5zdHViTiAqIHBhcmFtcy5zdHViTGVuZ3RoLCBwYXJhbXMueU4gKTtcbiAgICB9XG5cbiAgICBob3Jpem9udGFsKCBwYXJhbXMueE4gKTtcbiAgICBpZiggIXBhcmFtcy5yZXZlcnNlICkge1xuICAgICAgYXJyb3dIZWFkKCk7XG4gICAgfVxuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgZnVuY3Rpb24gY3ViaWMoIHRvWCwgdG9ZICkge1xuICAgIGNvbnN0IG1pZGRsZVggPSB4ICsgKHRvWCAtIHgpIC8gMjtcbiAgICBwYXRoLnB1c2goICdDJywgbWlkZGxlWCwgJywnLCB5LCAnICcsIG1pZGRsZVgsICcsJywgdG9ZLCAnICcsIHRvWCwgJywnLCB0b1kgKTtcbiAgICB4ID0gdG9YO1xuICAgIHkgPSB0b1k7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBmdW5jdGlvbiBjdWJpY1koIHRvWCwgdG9ZICkge1xuICAgIGNvbnN0IG1pZGRsZVkgPSB5ICsgKHRvWSAtIHkpIC8gMjtcbiAgICBwYXRoLnB1c2goICdDJywgeCwgJywnLCBtaWRkbGVZLCAnICcsIHRvWCwgJywnLCBtaWRkbGVZLCAnICcsIHRvWCwgJywnLCB0b1kgKTtcbiAgICB4ID0gdG9YO1xuICAgIHkgPSB0b1k7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBmdW5jdGlvbiBob3Jpem9udGFsKCB4QWJzICkge1xuICAgIHggPSB4QWJzO1xuICAgIHBhdGgucHVzaCggJ0gnLCB4ICk7XG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICBmdW5jdGlvbiBhcmM5MCggeFNnbiwgeVNnbiwgc3dlZXAgKSB7XG4gICAgeCArPSB4U2duICogcGFyYW1zLmN1cnZlUGFkZGluZztcbiAgICB5ICs9IHlTZ24gKiBwYXJhbXMuY3VydmVQYWRkaW5nO1xuICAgIHBhdGgucHVzaCggJ0EnLCBwYXJhbXMuY3VydmVQYWRkaW5nLCAnLCcsIHBhcmFtcy5jdXJ2ZVBhZGRpbmcsICcgMCAwLCcsIHN3ZWVwLCAnICcsIHgsICcsJywgeSApO1xuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgZnVuY3Rpb24gdmVydGljYWwoIHlBYnMgKSB7XG4gICAgeSA9IHlBYnM7XG4gICAgcGF0aC5wdXNoKCAnVicsIHlBYnMgKTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGZ1bmN0aW9uIGFycm93SGVhZCgpIHtcbiAgICBpZiggIXNob3dBcnJvdyApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBheCA9IHggLSBzdHViTGVuZ3RoIC0gYXJyb3dIZWFkTGVuZ3RoLCBheSA9IHk7XG4gICAgcGF0aC5wdXNoKFxuICAgICAgJ00nLCBheCwgJywnLCBheSAtIGFycm93SGVhZExlbmd0aCxcbiAgICAgICdMJywgYXggKyBzdHViTGVuZ3RoIC8gMiwgJywnLCBheSxcbiAgICAgICdMJywgYXgsICcsJywgYXkgKyBhcnJvd0hlYWRMZW5ndGgsXG4gICAgICAnTCcsIGF4ICsgYXJyb3dIZWFkTGVuZ3RoLCAnLCcsIGF5LFxuICAgICAgJ0wnLCBheCwgJywnLCBheSAtIGFycm93SGVhZExlbmd0aCxcbiAgICAgICdNJywgeCwgJywnLCB5XG4gICAgKTtcbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGZ1bmN0aW9uIGNpcmN1bXZlbnRCb3gwKCkge1xuICAgIGNvbnN0IHsgeE4sIHlOLCBib3gwLCBib3hOLCBjdXJ2ZVBhZGRpbmcgfSA9IHBhcmFtcztcbiAgICBjb25zdCB5RGlyID0gY2FsY3VsYXRlU3RhcnREaXJlY3Rpb25ZKCk7XG4gICAgY29uc3Qgc3dlZXAgPSB5RGlyID09PSAxID8gMCA6IDE7XG5cbiAgICBjaXJjdW12ZW50WSgpO1xuICAgIHJldHVybiBjaXJjdW12ZW50WCgpO1xuXG4gICAgZnVuY3Rpb24gY2lyY3VtdmVudFkoKSB7XG4gICAgICAvLyBBcmMgYW5kIGdvIHRvIGJvdHRvbS90b3A6XG4gICAgICBhcmM5MCggLTEsIHlEaXIsIHN3ZWVwICk7XG4gICAgICBpZiggeURpciA9PT0gMSApIHtcbiAgICAgICAgdmVydGljYWwoIG1heCggYm94MC5ib3R0b20sIHkgKyBjdXJ2ZVBhZGRpbmcgKSApO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHZlcnRpY2FsKCBtaW4oIGJveDAudG9wLCB5IC0gY3VydmVQYWRkaW5nICkgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjaXJjdW12ZW50WCgpIHtcbiAgICAgIC8vIENsaW5nIHRvIGJvdHRvbS90b3AgZWRnZSBhcyBmYXIgYXMgbmVlZGVkOlxuICAgICAgaWYoIHlOICogeURpciA8IHkgKiB5RGlyIHx8IGFicyggeSAtIHlOICkgKiA0IDwgYWJzKCB4IC0geE4gKSApIHtcbiAgICAgICAgYXJjOTAoIDEsIHlEaXIsIHN3ZWVwICk7XG4gICAgICAgIGlmKCB5TiAqIHlEaXIgPCB5ICogeURpciApIHtcbiAgICAgICAgICBob3Jpem9udGFsKCBtYXgoIHgsIG1pbiggYm94MC5yaWdodCwgeE4gLSAyICogY3VydmVQYWRkaW5nICkgKSApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmKCAhYm94TiAmJiB4TiA+IGJveDAubGVmdCApIHtcbiAgICAgICAgYXJjOTAoIDEsIHlEaXIsIHN3ZWVwICk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVN0YXJ0RGlyZWN0aW9uWSgpIHtcbiAgICAgIC8vIGRvd246IDEsIHVwOiAtMVxuICAgICAgaWYoICghYm94TiAmJiB5TiA+IHkpIHx8IChib3hOICYmIGJveE4udG9wID4gYm94MC5ib3R0b20pICkge1xuICAgICAgICAvLyBUaGUgZW50aXJlIGRlc3QgaXMgYmVsb3cgdGhpcyBib3g6IGFsd2F5cyBnbyBkb3dud2FyZHNcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICB9XG4gICAgICBpZiggKCFib3hOICYmIHlOIDwgeSkgfHwgKGJveE4gJiYgYm94Ti5ib3R0b20gPCBib3gwLnRvcCkgKSB7XG4gICAgICAgIC8vIFRoZSBlbnRpcmUgZGVzdCBpcyBhYm92ZSB0aGlzIGJveDogYWx3YXlzIGdvIHVwd2FyZHNcbiAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgfVxuICAgICAgLy8gU2hvcnRlc3QgcGF0aCB0byBlZGdlIG9mIHRoaXMgYm94XG4gICAgICByZXR1cm4gYWJzKCBib3gwLnRvcCAtIHkgKSA8IGFicyggeSAtIGJveDAuYm90dG9tICkgPyAtMSA6IDE7XG4gICAgfVxuICB9XG5cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgZnVuY3Rpb24gY2lyY3VtdmVudEJveE4oIHVzZUJlemllclkgKSB7XG4gICAgY29uc3QgeyBib3hOLCB5TiwgY3VydmVQYWRkaW5nIH0gPSBwYXJhbXM7XG5cbiAgICAvLyBEcmF3IGxpbmUgdG8gbmVhcmVzdCBjb3JuZXIgb2YgYm94TjpcbiAgICB2YXIgeURpciwgeUVkZ2UsIHhFZGdlLCBzd2VlcDtcbiAgICBpZiggYWJzKCBib3hOLnRvcCAtIHkgKSArICh5IDwgeU4gPyAtMSA6IDApIDwgYWJzKCB5IC0gYm94Ti5ib3R0b20gKSApIHtcbiAgICAgIHlEaXIgPSAxO1xuICAgICAgeUVkZ2UgPSBtaW4oIGJveE4udG9wIC0gY3VydmVQYWRkaW5nLCB5TiAtIDIgKiBjdXJ2ZVBhZGRpbmcgKTtcbiAgICAgIHN3ZWVwID0gMTtcbiAgICAgIHhFZGdlID0geUVkZ2UgPiB5ID8gYm94Ti5yaWdodCA6IGJveE4ubGVmdDtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB5RGlyID0gLTE7XG4gICAgICB5RWRnZSA9IG1heCggYm94Ti5ib3R0b20gKyBjdXJ2ZVBhZGRpbmcsIHlOICsgMiAqIGN1cnZlUGFkZGluZyApO1xuICAgICAgc3dlZXAgPSAwO1xuICAgICAgeEVkZ2UgPSB5RWRnZSA8IHkgPyBib3hOLnJpZ2h0IDogYm94Ti5sZWZ0O1xuICAgIH1cblxuICAgIGlmKCB1c2VCZXppZXJZICkge1xuICAgICAgY3ViaWNZKCBib3hOLnJpZ2h0ICsgY3VydmVQYWRkaW5nLCB5RWRnZSApO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIGN1YmljKCBtYXgoIHhFZGdlLCB4ICsgY3VydmVQYWRkaW5nICksIHlFZGdlICk7XG4gICAgICAvLyBTdGljayB0byBib3R0b20vdG9wIGVkZ2UgYXMgZmFyIGFzIG5lZWRlZDpcbiAgICAgIGhvcml6b250YWwoIGJveE4ucmlnaHQgKTtcbiAgICAgIGFyYzkwKCAxLCB5RGlyLCBzd2VlcCApO1xuICAgIH1cbiAgICAvLyB0dXJuIHRvd2FyZHMgcG9ydFxuICAgIHZlcnRpY2FsKCB5TiAtIHlEaXIgKiBjdXJ2ZVBhZGRpbmcgKTtcbiAgICBhcmM5MCggLTEsIHlEaXIsIHN3ZWVwICk7XG4gIH1cblxufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG5mdW5jdGlvbiBpbml0aWFsaXplUGFyYW1ldGVycyggZnJvbSwgdG8sIGJveGVzLCBzdHVicywgc3R1Ykxlbmd0aCwgY3VydmVQYWRkaW5nICkge1xuICBjb25zdCBwYXJhbXMgPSB7IHN0dWJMZW5ndGg6IHN0dWJMZW5ndGgsIGN1cnZlUGFkZGluZzogY3VydmVQYWRkaW5nIH07XG5cbiAgY29uc3QgZnJvbUxlZnQgPSBmcm9tWyBYIF0sIGZyb21Ub3AgPSBmcm9tWyBZIF07XG4gIGNvbnN0IHRvTGVmdCA9IHRvWyBYIF0sIHRvVG9wID0gdG9bIFkgXTtcbiAgY29uc3QgZnJvbUJveCA9IGJveGVzWyBGUk9NIF0sIHRvQm94ID0gYm94ZXNbIFRPIF07XG4gIGNvbnN0IGZyb21TdHViID0gc3R1YnNbIEZST00gXSwgdG9TdHViID0gc3R1YnNbIFRPIF07XG5cbiAgY29uc3Qgc2FmZUJveERpc3RhbmNlID0gMyAqIHN0dWJMZW5ndGg7XG4gIGNvbnN0IG1pblN0dWJMZW5ndGggPSAzO1xuICBjb25zdCBtaW5DdXJ2ZVBhZGRpbmcgPSAxO1xuXG4gIHZhciB5UmF0aW8gPSAxO1xuICBpZiggdG9Cb3ggKSB7XG4gICAgdmFyIGJveERlbHRhWSA9IGFicyggdG9Ub3AgPiBmcm9tVG9wID9cbiAgICAgIGZyb21Cb3guYm90dG9tIC0gdG9Cb3gudG9wIDpcbiAgICAgIHRvQm94LmJvdHRvbSAtIGZyb21Cb3gudG9wICk7XG4gICAgaWYoIGJveERlbHRhWSA8IHNhZmVCb3hEaXN0YW5jZSApIHtcbiAgICAgIHlSYXRpbyA9IGJveERlbHRhWSAvIHNhZmVCb3hEaXN0YW5jZTtcbiAgICAgIHBhcmFtcy5jdXJ2ZVBhZGRpbmcgPSBtYXgoIG1pblN0dWJMZW5ndGgsIG1heCggMSwgcm91bmQoIHlSYXRpbyAqIGN1cnZlUGFkZGluZyApICkgKTtcbiAgICB9XG4gIH1cblxuICB2YXIgZGVsdGFYID0gYWJzKCBmcm9tTGVmdCAtIHRvTGVmdCApO1xuICBpZiggZGVsdGFYIDwgc2FmZUJveERpc3RhbmNlICYmIHlSYXRpbyA8IDEgKSB7XG4gICAgdmFyIHhSYXRpbyA9IGRlbHRhWCAvIHNhZmVCb3hEaXN0YW5jZTtcbiAgICBwYXJhbXMuc3R1Ykxlbmd0aCA9IG1heCggbWluU3R1Ykxlbmd0aCwgcm91bmQoIHhSYXRpbyAqIHN0dWJMZW5ndGggKSApO1xuICAgIHBhcmFtcy5jdXJ2ZVBhZGRpbmcgPSBtYXgoIG1pbkN1cnZlUGFkZGluZywgcm91bmQoIHhSYXRpbyAqIGN1cnZlUGFkZGluZyApICk7XG4gIH1cblxuICAvLyBTaW1wbGlmeSBieSBhbHdheXMgZHJhd2luZyBhIHBhdGggZnJvbSBsZWZ0IHRvIHJpZ2h0OlxuICBwYXJhbXMucmV2ZXJzZSA9XG4gICAgZnJvbUxlZnQgKyBmcm9tU3R1YiAqIHN0dWJMZW5ndGggPlxuICAgIHRvTGVmdCArIHRvU3R1YiAqIHN0dWJMZW5ndGg7XG4gIGlmKCBwYXJhbXMucmV2ZXJzZSApIHtcbiAgICBwYXJhbXMueDAgPSByb3VuZCggdG9MZWZ0ICk7XG4gICAgcGFyYW1zLnhOID0gcm91bmQoIGZyb21MZWZ0ICk7XG4gICAgcGFyYW1zLnkwID0gcm91bmQoIHRvVG9wICk7XG4gICAgcGFyYW1zLnlOID0gcm91bmQoIGZyb21Ub3AgKTtcbiAgICBwYXJhbXMuc3R1YjAgPSB0b1N0dWI7XG4gICAgcGFyYW1zLnN0dWJOID0gZnJvbVN0dWI7XG4gICAgcGFyYW1zLmJveDAgPSB0b0JveDtcbiAgICBwYXJhbXMuYm94TiA9IGZyb21Cb3g7XG4gIH1cbiAgZWxzZSB7XG4gICAgcGFyYW1zLngwID0gcm91bmQoIGZyb21MZWZ0ICk7XG4gICAgcGFyYW1zLnhOID0gcm91bmQoIHRvTGVmdCApO1xuICAgIHBhcmFtcy55MCA9IHJvdW5kKCBmcm9tVG9wICk7XG4gICAgcGFyYW1zLnlOID0gcm91bmQoIHRvVG9wICk7XG4gICAgcGFyYW1zLnN0dWIwID0gZnJvbVN0dWI7XG4gICAgcGFyYW1zLnN0dWJOID0gdG9TdHViO1xuICAgIHBhcmFtcy5ib3gwID0gZnJvbUJveDtcbiAgICBwYXJhbXMuYm94TiA9IHRvQm94O1xuICB9XG5cbiAgcmV0dXJuIHBhcmFtcztcbn1cbiJdfQ==