define(['exports', 'module', 'dagre'], function (exports, module, _dagre) {
  'use strict';

  module.exports = { calculateLayout: calculateLayout };

  function calculateLayout(graph, measurements) {

    window.console.log('GRAPH: ', graph.toJS()); // :TODO: DELETE ME
    window.console.log('MEASUREMENTS: ', measurements.toJS()); // :TODO: DELETE ME

    var owners = {
      inbound: {},
      outbound: {}
    };

    var dg = new _dagre.graphlib.Graph();
    // dagre.layout().nodeSep( 60 ).rankSep( 90 ).edgeSep( 0 ).rankDir( 'LR' ).run( dagreGraph );
    dg.setGraph({
      rankdir: 'LR',
      nodesep: 60,
      ranksep: 90,
      edgesep: 0,
      marginx: 15,
      marginy: 15
    });
    dg.setDefaultEdgeLabel(function () {
      return {};
    });
    measurements.get('edges').forEach(add('E.'));
    measurements.get('vertices').forEach(add('V.'));
    graph.get('vertices').forEach(collectOwningVertices());
    graph.get('vertices').forEach(connect);

    _dagre.layout(dg);
    return {
      vertices: decode('V.', dg.nodes()),
      edges: decode('E.', dg.nodes())
    };

    function connect(vertex, vertexId) {
      var dgVertexId = 'V.' + vertexId;
      [vertex.ports.inbound, vertex.ports.outbound].forEach(function (group, groupNo) {
        var isInbound = groupNo === 0;
        group.forEach(function (_ref) {
          var edgeId = _ref.edgeId;

          if (!edgeId) {
            return;
          }
          var dgNeighborId = 'E.' + edgeId;
          if (!measurements.get('edges').get(edgeId)) {
            // invisible edge, "owned" by a vertex
            dgNeighborId = 'V.' + owners[isInbound ? 'outbound' : 'inbound'][edgeId];
          }

          window.console.log('CON', isInbound ? dgNeighborId : dgVertexId, ' --> ', isInbound ? dgVertexId : dgNeighborId);
          dg.setEdge(isInbound ? dgNeighborId : dgVertexId, isInbound ? dgVertexId : dgNeighborId);
        });
      });
    }

    function add(prefix) {
      return function (_ref2, nodeId) {
        var _ref2$dimensions = _ref2.dimensions;
        var width = _ref2$dimensions.width;
        var height = _ref2$dimensions.height;

        var dgNodeId = prefix + nodeId;
        dg.setNode(dgNodeId, { label: dgNodeId, width: width, height: height });
      };
    }

    function collectOwningVertices() {
      return function (vertex, vertexId) {
        [vertex.ports.inbound, vertex.ports.outbound].forEach(function (group, groupNo) {
          var isInbound = groupNo === 0;
          group.forEach(function (_ref3) {
            var edgeId = _ref3.edgeId;

            if (!edgeId) {
              return;
            }
            owners[isInbound ? 'inbound' : 'outbound'][edgeId] = vertexId;
          });
        });
      };
    }

    function decode(prefix, dgNodes) {
      var result = {};
      dgNodes.forEach(function (dgNodeId) {
        var _dg$node = dg.node(dgNodeId);

        var label = _dg$node.label;
        var width = _dg$node.width;
        var height = _dg$node.height;
        var x = _dg$node.x;
        var y = _dg$node.y;

        if (label.indexOf(prefix) === 0) {
          var id = label.substring(prefix.length, label.length);
          result[id] = {
            left: x - width / 2,
            top: y - height / 2
          };
        }
      });
      return result;
    }
  }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9taWNoYWVsL3dvcmsvZ2l0aHViLmNvbS94MUIvd2lyZWZsb3cvc3JjL3V0aWwvbGF5b3V0LmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7bUJBRWUsRUFBRSxlQUFlLEVBQWYsZUFBZSxFQUFFOztBQUVsQyxXQUFTLGVBQWUsQ0FBRSxLQUFLLEVBQUUsWUFBWSxFQUFHOztBQUU5QyxVQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRSxTQUFTLEVBQUUsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFFLENBQUM7QUFDOUMsVUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUUsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFFLENBQUM7O0FBRTVELFFBQU0sTUFBTSxHQUFHO0FBQ2IsYUFBTyxFQUFFLEVBQUU7QUFDWCxjQUFRLEVBQUUsRUFBRTtLQUNiLENBQUM7O0FBRUYsUUFBTSxFQUFFLEdBQUcsSUFBSSxPQUFNLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQzs7QUFFdEMsTUFBRSxDQUFDLFFBQVEsQ0FBRTtBQUNYLGFBQU8sRUFBRSxJQUFJO0FBQ2IsYUFBTyxFQUFFLEVBQUU7QUFDWCxhQUFPLEVBQUUsRUFBRTtBQUNYLGFBQU8sRUFBRSxDQUFDO0FBQ1YsYUFBTyxFQUFFLEVBQUU7QUFDWCxhQUFPLEVBQUUsRUFBRTtLQUNaLENBQUUsQ0FBQztBQUNKLE1BQUUsQ0FBQyxtQkFBbUIsQ0FBRSxZQUFNO0FBQUUsYUFBTyxFQUFFLENBQUM7S0FBRSxDQUFFLENBQUM7QUFDL0MsZ0JBQVksQ0FBQyxHQUFHLENBQUUsT0FBTyxDQUFFLENBQUMsT0FBTyxDQUFFLEdBQUcsQ0FBRSxJQUFJLENBQUUsQ0FBRSxDQUFDO0FBQ25ELGdCQUFZLENBQUMsR0FBRyxDQUFFLFVBQVUsQ0FBRSxDQUFDLE9BQU8sQ0FBRSxHQUFHLENBQUUsSUFBSSxDQUFFLENBQUUsQ0FBQztBQUN0RCxTQUFLLENBQUMsR0FBRyxDQUFFLFVBQVUsQ0FB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QUM7V0FDbkUsQ0FBRSxDQUFDO1NBQ0wsQ0FBRSxDQUFDO09BQ0wsQ0FBQztLQUNIOztBQUdELGFBQVMsTUFBTSxDQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUc7QUFDakMsVUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2hCLGFBQU8sQ0FBQyxPQUFPLENBQUUsVUFBQSxRQUFRLEVBQUk7dUJBQ1ksRUFBRSxDQUFDLElBQUksQ0FBRSxRQUFRLENBQUU7O1lBQWxELEtBQUssWUFBTCxLQUFLO1lBQUUsS0FBSyxZQUFMLEtBQUs7WUFBRSxNQUFNLFlBQU4sTUFBTTtZQUFFLENBQUMsWUFBRCxDQUFDO1lBQUUsQ0FBQyxZQUFELENBQUM7O0FBQ2xDLFlBQUksS0FBSyxDQUFDLE9BQU8sQ0FBRSxNQUFNLENBQUUsS0FBSyxDQUFDLEVBQUc7QUFDbEMsY0FBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBRSxNQUFNLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUUsQ0FBQztBQUMxRCxnQkFBTSxDQUFFLEVBQUUsQ0FBRSxHQUFHO0FBQ2IsZ0JBQUksRUFBRSxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUM7QUFDbkIsZUFBRyxFQUFFLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQztXQUNwQixDQUFDO1NBQ0g7T0FDRixDQUFFLENBQUM7QUFDSixhQUFPLE1BQU0sQ0FBQztLQUNmO0dBQ0YiLCJmaWxlIjoiL1VzZXJzL21pY2hhZWwvd29yay9naXRodWIuY29tL3gxQi93aXJlZmxvdy9zcmMvdXRpbC9sYXlvdXQuanN4Iiwic291cmNlUm9vdCI6InNyYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRhZ3JlIGZyb20gJ2RhZ3JlJztcblxuZXhwb3J0IGRlZmF1bHQgeyBjYWxjdWxhdGVMYXlvdXQgfTtcblxuZnVuY3Rpb24gY2FsY3VsYXRlTGF5b3V0KCBncmFwaCwgbWVhc3VyZW1lbnRzICkge1xuXG4gIHdpbmRvdy5jb25zb2xlLmxvZyggJ0dSQVBIOiAnLCBncmFwaC50b0pTKCkgKTsgLy8gOlRPRE86IERFTEVURSBNRVxuICB3aW5kb3cuY29uc29sZS5sb2coICdNRUFTVVJFTUVOVFM6ICcsIG1lYXN1cmVtZW50cy50b0pTKCkgKTsgLy8gOlRPRE86IERFTEVURSBNRVxuXG4gIGNvbnN0IG93bmVycyA9IHtcbiAgICBpbmJvdW5kOiB7fSxcbiAgICBvdXRib3VuZDoge31cbiAgfTtcblxuICBjb25zdCBkZyA9IG5ldyBkYWdyZS5ncmFwaGxpYi5HcmFwaCgpO1xuICAvLyBkYWdyZS5sYXlvdXQoKS5ub2RlU2VwKCA2MCApLnJhbmtTZXAoIDkwICkuZWRnZVNlcCggMCApLnJhbmtEaXIoICdMUicgKS5ydW4oIGRhZ3JlR3JhcGggKTtcbiAgZGcuc2V0R3JhcGgoIHtcbiAgICByYW5rZGlyOiAnTFInLFxuICAgIG5vZGVzZXA6IDYwLFxuICAgIHJhbmtzZXA6IDkwLFxuICAgIGVkZ2VzZXA6IDAsXG4gICAgbWFyZ2lueDogMTUsXG4gICAgbWFyZ2lueTogMTVcbiAgfSApO1xuICBkZy5zZXREZWZhdWx0RWRnZUxhYmVsKCAoKSA9PiB7IHJldHVybiB7fTsgfSApO1xuICBtZWFzdXJlbWVudHMuZ2V0KCAnZWRnZXMnICkuZm9yRWFjaCggYWRkKCAnRS4nICkgKTtcbiAgbWVhc3VyZW1lbnRzLmdldCggJ3ZlcnRpY2VzJyApLmZvckVhY2goIGFkZCggJ1YuJyApICk7XG4gIGdyYXBoLmdldCggJ3ZlcnRpY2VzJyApLmZvckVhY2goIGNvbGxlY3RPd25pbmdWZXJ0aWNlcygpICk7XG4gIGdyYXBoLmdldCggJ3ZlcnRpY2VzJyApLmZvckVhY2goIGNvbm5lY3QgKTtcblxuXG4gIGRhZ3JlLmxheW91dCggZGcgKTtcbiAgcmV0dXJuIHtcbiAgICB2ZXJ0aWNlczogZGVjb2RlKCAnVi4nLCBkZy5ub2RlcygpICksXG4gICAgZWRnZXM6IGRlY29kZSggJ0UuJywgZGcubm9kZXMoKSApXG4gIH07XG5cblxuICBmdW5jdGlvbiBjb25uZWN0KCB2ZXJ0ZXgsIHZlcnRleElkICkge1xuICAgIGNvbnN0IGRnVmVydGV4SWQgPSAnVi4nICsgdmVydGV4SWQ7XG4gICAgWyB2ZXJ0ZXgucG9ydHMuaW5ib3VuZCwgdmVydGV4LnBvcnRzLm91dGJvdW5kIF0uZm9yRWFjaCggKGdyb3VwLCBncm91cE5vKSA9PiB7XG4gICAgICBjb25zdCBpc0luYm91bmQgPSBncm91cE5vID09PSAwO1xuICAgICAgZ3JvdXAuZm9yRWFjaCggKHsgZWRnZUlkIH0pID0+IHtcbiAgICAgICAgaWYoICFlZGdlSWQgKSB7IHJldHVybjsgfVxuICAgICAgICB2YXIgZGdOZWlnaGJvcklkID0gJ0UuJyArIGVkZ2VJZDtcbiAgICAgICAgaWYoICFtZWFzdXJlbWVudHMuZ2V0KCAnZWRnZXMnICkuZ2V0KCBlZGdlSWQgKSApIHtcbiAgICAgICAgICAvLyBpbnZpc2libGUgZWRnZSwgXCJvd25lZFwiIGJ5IGEgdmVydGV4XG4gICAgICAgICAgZGdOZWlnaGJvcklkID0gJ1YuJyArIG93bmVyc1sgaXNJbmJvdW5kID8gJ291dGJvdW5kJyA6ICdpbmJvdW5kJyBdWyBlZGdlSWQgXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhcbiAgICAgICAgICAnQ09OJyxcbiAgICAgICAgICBpc0luYm91bmQgPyBkZ05laWdoYm9ySWQgOiBkZ1ZlcnRleElkLFxuICAgICAgICAgICcgLS0+ICcsXG4gICAgICAgICAgaXNJbmJvdW5kID8gZGdWZXJ0ZXhJZCA6IGRnTmVpZ2hib3JJZFxuICAgICAgICApO1xuICAgICAgICBkZy5zZXRFZGdlKFxuICAgICAgICAgIGlzSW5ib3VuZCA/IGRnTmVpZ2hib3JJZCA6IGRnVmVydGV4SWQsXG4gICAgICAgICAgaXNJbmJvdW5kID8gZGdWZXJ0ZXhJZCA6IGRnTmVpZ2hib3JJZFxuICAgICAgICApO1xuICAgICAgfSApO1xuICAgIH0gKTtcbiAgfVxuXG5cbiAgZnVuY3Rpb24gYWRkKCBwcmVmaXggKSB7XG4gICAgcmV0dXJuICh7IGRpbWVuc2lvbnM6IHsgd2lkdGgsIGhlaWdodCB9IH0sIG5vZGVJZCkgPT4ge1xuICAgICAgY29uc3QgZGdOb2RlSWQgPSBwcmVmaXggKyBub2RlSWQ7XG4gICAgICBkZy5zZXROb2RlKCBkZ05vZGVJZCwgeyBsYWJlbDogZGdOb2RlSWQsIHdpZHRoLCBoZWlnaHQgfSApO1xuICAgIH07XG4gIH1cblxuXG4gIGZ1bmN0aW9uIGNvbGxlY3RPd25pbmdWZXJ0aWNlcygpIHtcbiAgICByZXR1cm4gKCB2ZXJ0ZXgsIHZlcnRleElkICkgPT4ge1xuICAgICAgWyB2ZXJ0ZXgucG9ydHMuaW5ib3VuZCwgdmVydGV4LnBvcnRzLm91dGJvdW5kIF0uZm9yRWFjaCggKGdyb3VwLCBncm91cE5vKSA9PiB7XG4gICAgICAgIGNvbnN0IGlzSW5ib3VuZCA9IGdyb3VwTm8gPT09IDA7XG4gICAgICAgIGdyb3VwLmZvckVhY2goICh7IGVkZ2VJZCB9KSA9PiB7XG4gICAgICAgICAgaWYoICFlZGdlSWQgKSB7IHJldHVybjsgfVxuICAgICAgICAgIG93bmVyc1sgaXNJbmJvdW5kID8gJ2luYm91bmQnIDogJ291dGJvdW5kJyBdWyBlZGdlSWQgXSA9IHZlcnRleElkO1xuICAgICAgICB9ICk7XG4gICAgICB9ICk7XG4gICAgfTtcbiAgfVxuXG5cbiAgZnVuY3Rpb24gZGVjb2RlKCBwcmVmaXgsIGRnTm9kZXMgKSB7XG4gICAgdmFyIHJlc3VsdCA9IHt9O1xuICAgIGRnTm9kZXMuZm9yRWFjaCggZGdOb2RlSWQgPT4ge1xuICAgICAgY29uc3QgeyBsYWJlbCwgd2lkdGgsIGhlaWdodCwgeCwgeSB9ID0gZGcubm9kZSggZGdOb2RlSWQgKTtcbiAgICAgIGlmKCBsYWJlbC5pbmRleE9mKCBwcmVmaXggKSA9PT0gMCApIHtcbiAgICAgICAgY29uc3QgaWQgPSBsYWJlbC5zdWJzdHJpbmcoIHByZWZpeC5sZW5ndGgsIGxhYmVsLmxlbmd0aCApO1xuICAgICAgICByZXN1bHRbIGlkIF0gPSB7XG4gICAgICAgICAgbGVmdDogeCAtIHdpZHRoIC8gMixcbiAgICAgICAgICB0b3A6IHkgLSBoZWlnaHQgLyAyXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSApO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cbiJdfQ==