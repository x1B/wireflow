define(['exports', 'module', '../polyfill/object-assign'], function (exports, module, _polyfillObjectAssign) {
  'use strict';

  module.exports = dragdrop;
  var abs = Math.abs;

  var defaultDragThreshold = 3;

  function dragdrop(options) {

    var noOp = function noOp() {
      return true;
    };
    var doc = window.document;

    var _Object$assign = Object.assign({
      onBeforeStart: noOp,
      dragThreshold: defaultDragThreshold,
      onStart: noOp,
      onMove: noOp,
      onCancel: noOp,
      onDrop: noOp,
      onEnd: noOp,
      onClick: noOp,
      containerNode: doc.documentElement,
      getDropResult: null
    }, options);

    var onBeforeStart = _Object$assign.onBeforeStart;
    var dragThreshold = _Object$assign.dragThreshold;
    var onStart = _Object$assign.onStart;
    var onMove = _Object$assign.onMove;
    var onCancel = _Object$assign.onCancel;
    var onDrop = _Object$assign.onDrop;
    var onEnd = _Object$assign.onEnd;
    var onClick = _Object$assign.onClick;
    var containerNode = _Object$assign.containerNode;
    var getDropResult = _Object$assign.getDropResult;

    // drag state:
    var dragStarted = false;
    var startClientX = 0;
    var startClientY = 0;
    var dragX = 0;
    var dragY = 0;

    var base = undefined;
    var dragPayload = undefined;
    var dragNode = undefined;
    var dropResult = undefined;
    var dropNode = undefined;

    return { start: start };

    function start(ev, payload, node) {
      // we still need a minimum distance for actual drag
      dragStarted = false;
      var isLeftButton = ev.button === 0;
      var isTouch = (ev.targetTouches || []).length;

      var _ref = isTouch ? ev.targetTouches[0] : ev;

      var target = _ref.target;
      var clientX = _ref.clientX;
      var clientY = _ref.clientY;

      var _target$getBoundingClientRect = target.getBoundingClientRect();

      var left = _target$getBoundingClientRect.left;
      var top = _target$getBoundingClientRect.top;

      var offsetX = clientX - left;
      var offsetY = clientY - top;
      if ((isLeftButton || isTouch) && onBeforeStart(ev, offsetX, offsetY)) {
        base = { baseX: offsetX, baseY: offsetY };
        dragNode = node || ev.currentTarget;
        dragPayload = payload;
        startClientX = clientX;
        startClientY = clientY;

        doc.addEventListener('click', maybeClick);
        doc.addEventListener('mousemove', move);
        doc.addEventListener('touchmove', move);
        doc.addEventListener('mouseup', tryDrop);
        doc.addEventListener('touchend', tryDrop);
        doc.addEventListener('touchcancel', cancel);
        ev.preventDefault();
      }
    }

    function move(ev) {
      var isTouch = (ev.targetTouches || []).length;

      var _ref2 = isTouch ? ev.targetTouches[0] : ev;

      var clientX = _ref2.clientX;
      var clientY = _ref2.clientY;

      dragX = clientX - startClientX;
      dragY = clientY - startClientY;

      if (!dragStarted && abs(dragX) < dragThreshold && abs(dragY) < dragThreshold) {
        return;
      }

      if (!dragStarted) {
        onStart(ev);
        dragStarted = true;
      }

      var _anyDropResult = anyDropResult(clientX, clientY);

      var node = _anyDropResult.node;
      var result = _anyDropResult.result;

      dropNode = node;
      dropResult = result;
      onMove(state(), ev);
    }

    function cancel(ev) {
      onCancel(state(), ev);
      end(ev);
    }

    function tryDrop(ev) {
      (dropResult ? onDrop : onCancel)(state(), ev);
      end(ev);
    }

    function end(ev) {
      doc.removeEventListener('mousemove', move);
      doc.removeEventListener('touchmove', move);
      doc.removeEventListener('mouseup', tryDrop);
      doc.removeEventListener('touchend', tryDrop);
      doc.removeEventListener('touchcancel', cancel);
      dragPayload = dropNode = dropResult = null;
      onEnd(state(), ev);
    }

    function maybeClick(ev) {
      doc.removeEventListener('click', maybeClick);
      if (!dragStarted) {
        onClick(ev);
      }
    }

    function anyDropResult(clientX, clientY) {
      var node = null;
      var result = null;
      if (!getDropResult) {
        return { node: node, result: result };
      }

      node = doc.elementFromPoint(clientX, clientY);
      while (node && node !== containerNode) {
        result = getDropResult(node, dragPayload);
        // truthy: use as result
        if (result) {
          break;
        }
        // false: cancel looking immediately
        if (result === false) {
          node = null;
          break;
        }
        // falsy but not false: keep looking
        node = node.parentNode;
      }
      return { node: node, result: result };
    }

    function state() {
      return {
        base: base,
        dragPayload: dragPayload,
        dragNode: dragNode,
        dragX: dragX,
        dragY: dragY,
        dropResult: dropResult,
        dropNode: dropNode
      };
    }
  }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2RyYWdkcm9wLmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7bUJBTXdCLFFBQVE7TUFIeEIsR0FBRyxHQUFLLElBQUksQ0FBWixHQUFHOztBQUNYLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDOztBQUVoQixXQUFTLFFBQVEsQ0FBRSxPQUFPLEVBQUc7O0FBRTFDLFFBQU0sSUFBSSxHQUFHLFNBQVAsSUFBSTthQUFTLElBQUk7S0FBQSxDQUFDO0FBQ3hCLFFBQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUM7O3lCQWF4QixNQUFNLENBQUMsTUFBTSxDQUFFO0FBQ2pCLG1CQUFhLEVBQUUsSUFBSTtBQUNuQixtQkFBYSxFQUFFLG9CQUFvQjtBQUNuQyxhQUFPLEVBQUUsSUFBSTtBQUNiLFlBQU0sRUFBRSxJQUFJO0FBQ1osY0FBUSxFQUFFLElBQUk7QUFDZCxZQUFNLEVBQUUsSUFBSTtBQUNaLFdBQUssRUFBRSxJQUFJO0FBQ1gsYUFBTyxFQUFFLElBQUk7QUFDYixtQkFBYSxFQUFFLEdBQUcsQ0FBQyxlQUFlO0FBQ2xDLG1CQUFhLEVBQUUsSUFBSTtLQUNwQixFQUFFLE9BQU8sQ0FBRTs7UUFyQlYsYUFBYSxrQkFBYixhQUFhO1FBQ2IsYUFBYSxrQkFBYixhQUFhO1FBQ2IsT0FBTyxrQkFBUCxPQUFPO1FBQ1AsTUFBTSxrQkFBTixNQUFNO1FBQ04sUUFBUSxrQkFBUixRQUFRO1FBQ1IsTUFBTSxrQkFBTixNQUFNO1FBQ04sS0FBSyxrQkFBTCxLQUFLO1FBQ0wsT0FBTyxrQkFBUCxPQUFPO1FBQ1AsYUFBYSxrQkFBYixhQUFhO1FBQ2IsYUFBYSxrQkFBYixhQUFhOzs7QUFlZixRQUFJLFdBQVcsR0FBRyxLQUFLLENBQUM7QUFDeEIsUUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3JCLFFBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztBQUNyQixRQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDZCxRQUFJLEtB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QyxVQUFJLENBQUMsV0FBVyxFQUFHO0FBQ2pCLGVBQU8sQ0FBRSxFQUFFLENBQUUsQ0FBQztPQUNmO0tBQ0Y7O0FBR0QsYUFBUyxhQUFhLENBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRztBQUN6QyxVQUFJLElBQUksR0FBRyxJQUFJLENBQUM7QUFDaEIsVUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ2xCLFVBQUksQ0FBQyxhQUFhLEVBQUc7QUFDbkIsZUFBTyxFQUFFLElBQUksRUFBSixJQUFJLEVBQUUsTUFBTSxFQUFOLE1BQU0sRUFBRSxDQUFDO09BQ3pCOztBQUVELFVBQUksR0FBRyxHQUFHLENBQUMsZ0JBQWdCLENBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBRSxDQUFDO0FBQ2hELGFBQU8sSUFBSSxJQUFJLElBQUksS0FBSyxhQUFhLEVBQUc7QUFDdEMsY0FBTSxHQUFHLGFBQWEsQ0FBRSxJQUFJLEVBQUUsV0FBVyxDQUFFLENBQUM7O0FBRTVDLFlBQUksTUFBTSxFQUFHO0FBQ1gsZ0JBQU07U0FDUDs7QUFFRCxZQUFJLE1BQU0sS0FBSyxLQUFLLEVBQUc7QUFDckIsY0FBSSxHQUFHLElBQUksQ0FBQztBQUNaLGdCQUFNO1NBQ1A7O0FBRUQsWUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7T0FDeEI7QUFDRCxhQUFPLEVBQUUsSUFBSSxFQUFKLElBQUksRUFBRSxNQUFNLEVBQU4sTUFBTSxFQUFFLENBQUM7S0FDekI7O0FBR0QsYUFBUyxLQUFLLEdBQUc7QUFDZixhQUFPO0FBQ0wsWUFBSSxFQUFKLElBQUk7QUFDSixtQkFBVyxFQUFYLFdBQVc7QUFDWCxnQkFBUSxFQUFSLFFBQVE7QUFDUixhQUFLLEVBQUwsS0FBSztBQUNMLGFBQUssRUFBTCxLQUFLO0FBQ0wsa0JBQVUsRUFBVixVQUFVO0FBQ1YsZ0JBQVEsRUFBUixRQUFRO09BQ1QsQ0FBQztLQUNIO0dBQ0YiLCJmaWxlIjoiZHJhZ2Ryb3AuanMiLCJzb3VyY2VSb290Ijoic3JjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuLi9wb2x5ZmlsbC9vYmplY3QtYXNzaWduJztcblxuXG5jb25zdCB7IGFicyB9ID0gTWF0aDtcbmNvbnN0IGRlZmF1bHREcmFnVGhyZXNob2xkID0gMztcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZHJhZ2Ryb3AoIG9wdGlvbnMgKSB7XG5cbiAgY29uc3Qgbm9PcCA9ICgpID0+IHRydWU7XG4gIGNvbnN0IGRvYyA9IHdpbmRvdy5kb2N1bWVudDtcblxuICBjb25zdCB7XG4gICAgb25CZWZvcmVTdGFydCxcbiAgICBkcmFnVGhyZXNob2xkLFxuICAgIG9uU3RhcnQsXG4gICAgb25Nb3ZlLFxuICAgIG9uQ2FuY2VsLFxuICAgIG9uRHJvcCxcbiAgICBvbkVuZCxcbiAgICBvbkNsaWNrLFxuICAgIGNvbnRhaW5lck5vZGUsXG4gICAgZ2V0RHJvcFJlc3VsdFxuICB9ID0gT2JqZWN0LmFzc2lnbigge1xuICAgIG9uQmVmb3JlU3RhcnQ6IG5vT3AsXG4gICAgZHJhZ1RocmVzaG9sZDogZGVmYXVsdERyYWdUaHJlc2hvbGQsXG4gICAgb25TdGFydDogbm9PcCxcbiAgICBvbk1vdmU6IG5vT3AsXG4gICAgb25DYW5jZWw6IG5vT3AsXG4gICAgb25Ecm9wOiBub09wLFxuICAgIG9uRW5kOiBub09wLFxuICAgIG9uQ2xpY2s6IG5vT3AsXG4gICAgY29udGFpbmVyTm9kZTogZG9jLmRvY3VtZW50RWxlbWVudCxcbiAgICBnZXREcm9wUmVzdWx0OiBudWxsXG4gIH0sIG9wdGlvbnMgKTtcblxuICAvLyBkcmFnIHN0YXRlOlxuICBsZXQgZHJhZ1N0YXJ0ZWQgPSBmYWxzZTtcbiAgbGV0IHN0YXJ0Q2xpZW50WCA9IDA7XG4gIGxldCBzdGFydENsaWVudFkgPSAwO1xuICBsZXQgZHJhZ1ggPSAwO1xuICBsZXQgZHJhZ1kgPSAwO1xuXG4gIGxldCBiYXNlO1xuICBsZXQgZHJhZ1BheWxvYWQ7XG4gIGxldCBkcmFnTm9kZTtcbiAgbGV0IGRyb3BSZXN1bHQ7XG4gIGxldCBkcm9wTm9kZTtcblxuICByZXR1cm4geyBzdGFydCB9O1xuXG5cbiAgZnVuY3Rpb24gc3RhcnQoIGV2LCBwYXlsb2FkLCBub2RlICkge1xuICAgIC8vIHdlIHN0aWxsIG5lZWQgYSBtaW5pbXVtIGRpc3RhbmNlIGZvciBhY3R1YWwgZHJhZ1xuICAgIGRyYWdTdGFydGVkID0gZmFsc2U7XG4gICAgY29uc3QgaXNMZWZ0QnV0dG9uID0gZXYuYnV0dG9uID09PSAwO1xuICAgIGNvbnN0IGlzVG91Y2ggPSAoIGV2LnRhcmdldFRvdWNoZXMgfHwgW10gKS5sZW5ndGg7XG5cbiAgICBjb25zdCB7IHRhcmdldCwgY2xpZW50WCwgY2xpZW50WSB9ID0gaXNUb3VjaCA/IGV2LnRhcmdldFRvdWNoZXNbIDAgXSA6IGV2O1xuICAgIGNvbnN0IHsgbGVmdCwgdG9wIH0gPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3Qgb2Zmc2V0WCA9IGNsaWVudFggLSBsZWZ0O1xuICAgIGNvbnN0IG9mZnNldFkgPSBjbGllbnRZIC0gdG9wO1xuICAgIGlmKCAoaXNMZWZ0QnV0dG9uIHx8IGlzVG91Y2gpICYmIG9uQmVmb3JlU3RhcnQoIGV2LCBvZmZzZXRYLCBvZmZzZXRZICkgKSB7XG4gICAgICBiYXNlID0geyBiYXNlWDogb2Zmc2V0WCwgYmFzZVk6IG9mZnNldFkgfTtcbiAgICAgIGRyYWdOb2RlID0gbm9kZSB8fCBldi5jdXJyZW50VGFyZ2V0O1xuICAgICAgZHJhZ1BheWxvYWQgPSBwYXlsb2FkO1xuICAgICAgWyBzdGFydENsaWVudFgsIHN0YXJ0Q2xpZW50WSBdID0gWyBjbGllbnRYLCBjbGllbnRZIF07XG5cbiAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCAnY2xpY2snLCBtYXliZUNsaWNrICk7XG4gICAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lciggJ21vdXNlbW92ZScsIG1vdmUgKTtcbiAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCAndG91Y2htb3ZlJywgbW92ZSApO1xuICAgICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoICdtb3VzZXVwJywgdHJ5RHJvcCApO1xuICAgICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoICd0b3VjaGVuZCcsIHRyeURyb3AgKTtcbiAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCAndG91Y2hjYW5jZWwnLCBjYW5jZWwgKTtcbiAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICB9XG5cblxuICBmdW5jdGlvbiBtb3ZlKCBldiApIHtcbiAgICBjb25zdCBpc1RvdWNoID0gKCBldi50YXJnZXRUb3VjaGVzIHx8IFtdICkubGVuZ3RoO1xuICAgIGNvbnN0IHsgY2xpZW50WCwgY2xpZW50WSB9ID0gaXNUb3VjaCA/IGV2LnRhcmdldFRvdWNoZXNbIDAgXSA6IGV2O1xuICAgIGRyYWdYID0gY2xpZW50WCAtIHN0YXJ0Q2xpZW50WDtcbiAgICBkcmFnWSA9IGNsaWVudFkgLSBzdGFydENsaWVudFk7XG5cbiAgICBpZiggIWRyYWdTdGFydGVkICYmXG4gICAgICAgIGFicyggZHJhZ1ggKSA8IGRyYWdUaHJlc2hvbGQgJiYgYWJzKCBkcmFnWSApIDwgZHJhZ1RocmVzaG9sZCApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiggIWRyYWdTdGFydGVkICkge1xuICAgICAgb25TdGFydCggZXYgKTtcbiAgICAgIGRyYWdTdGFydGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBjb25zdCB7IG5vZGUsIHJlc3VsdCB9ID0gYW55RHJvcFJlc3VsdCggY2xpZW50WCwgY2xpZW50WSApO1xuICAgIGRyb3BOb2RlID0gbm9kZTtcbiAgICBkcm9wUmVzdWx0ID0gcmVzdWx0O1xuICAgIG9uTW92ZSggc3RhdGUoKSwgZXYgKTtcbiAgfVxuXG5cbiAgZnVuY3Rpb24gY2FuY2VsKCBldiApIHtcbiAgICBvbkNhbmNlbCggc3RhdGUoKSwgZXYgKTtcbiAgICBlbmQoIGV2ICk7XG4gIH1cblxuXG4gIGZ1bmN0aW9uIHRyeURyb3AoIGV2ICkge1xuICAgICggZHJvcFJlc3VsdCA/IG9uRHJvcCA6IG9uQ2FuY2VsICkoIHN0YXRlKCksIGV2ICk7XG4gICAgZW5kKCBldiApO1xuICB9XG5cblxuICBmdW5jdGlvbiBlbmQoIGV2ICkge1xuICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCAnbW91c2Vtb3ZlJywgbW92ZSApO1xuICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCAndG91Y2htb3ZlJywgbW92ZSApO1xuICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCAnbW91c2V1cCcsIHRyeURyb3AgKTtcbiAgICBkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3RvdWNoZW5kJywgdHJ5RHJvcCApO1xuICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCAndG91Y2hjYW5jZWwnLCBjYW5jZWwgKTtcbiAgICBkcmFnUGF5bG9hZCA9IGRyb3BOb2RlID0gZHJvcFJlc3VsdCA9IG51bGw7XG4gICAgb25FbmQoIHN0YXRlKCksIGV2ICk7XG4gIH1cblxuXG4gIGZ1bmN0aW9uIG1heWJlQ2xpY2soIGV2ICkge1xuICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCAnY2xpY2snLCBtYXliZUNsaWNrICk7XG4gICAgaWYoICFkcmFnU3RhcnRlZCApIHtcbiAgICAgIG9uQ2xpY2soIGV2ICk7XG4gICAgfVxuICB9XG5cblxuICBmdW5jdGlvbiBhbnlEcm9wUmVzdWx0KCBjbGllbnRYLCBjbGllbnRZICkge1xuICAgIGxldCBub2RlID0gbnVsbDtcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcbiAgICBpZiggIWdldERyb3BSZXN1bHQgKSB7XG4gICAgICByZXR1cm4geyBub2RlLCByZXN1bHQgfTtcbiAgICB9XG5cbiAgICBub2RlID0gZG9jLmVsZW1lbnRGcm9tUG9pbnQoIGNsaWVudFgsIGNsaWVudFkgKTtcbiAgICB3aGlsZSggbm9kZSAmJiBub2RlICE9PSBjb250YWluZXJOb2RlICkge1xuICAgICAgcmVzdWx0ID0gZ2V0RHJvcFJlc3VsdCggbm9kZSwgZHJhZ1BheWxvYWQgKTtcbiAgICAgIC8vIHRydXRoeTogdXNlIGFzIHJlc3VsdFxuICAgICAgaWYoIHJlc3VsdCApIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICAvLyBmYWxzZTogY2FuY2VsIGxvb2tpbmcgaW1tZWRpYXRlbHlcbiAgICAgIGlmKCByZXN1bHQgPT09IGZhbHNlICkge1xuICAgICAgICBub2RlID0gbnVsbDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICAvLyBmYWxzeSBidXQgbm90IGZhbHNlOiBrZWVwIGxvb2tpbmdcbiAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7XG4gICAgfVxuICAgIHJldHVybiB7IG5vZGUsIHJlc3VsdCB9O1xuICB9XG5cblxuICBmdW5jdGlvbiBzdGF0ZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgYmFzZSxcbiAgICAgIGRyYWdQYXlsb2FkLFxuICAgICAgZHJhZ05vZGUsXG4gICAgICBkcmFnWCxcbiAgICAgIGRyYWdZLFxuICAgICAgZHJvcFJlc3VsdCxcbiAgICAgIGRyb3BOb2RlXG4gICAgfTtcbiAgfVxufVxuIl19