define(['exports', 'immutable', '../layout-store', '../../../testing/dispatcher-mock', '../../../testing/diff', '../../graph/graph-actions', '../layout-actions', '../../history/history-actions', '../../graph/graph-model', '../layout-model', './data', '../../graph/spec/data'], function (exports, _immutable, _layoutStore, _testingDispatcherMock, _testingDiff, _graphGraphActions, _layoutActions, _historyHistoryActions, _graphGraphModel, _layoutModel, _data, _graphSpecData) {'use strict';function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { 'default': obj };}var _LayoutStore = _interopRequireDefault(_layoutStore);var _DispatcherMock = _interopRequireDefault(_testingDispatcherMock);var _diff = _interopRequireDefault(_testingDiff);var _data2 = _interopRequireDefault(_data);var _graphData = _interopRequireDefault(_graphSpecData);





























  function dummyGraph() {
    return _graphGraphModel.convert.graph(_graphData['default'].initial.graph);}


  function dummyLayout() {
    return _layoutModel.convert.layout(_data2['default'].initial.layout);}


  function dummyMeasurements() {
    return _layoutModel.convert.measurements(_data2['default'].initial.measurements);}



  // Jasmine:
  var jasmine = window.jasmine;var describe = window.describe;var beforeEach = window.beforeEach;var expect = window.expect;var it = window.it;var 
  any = jasmine.any;

  describe('A layout store', function () {

    var dispatcher;
    var store;
    var graphStoreMock;

    beforeEach(function () {
      dispatcher = new _DispatcherMock['default']();
      graphStoreMock = { graph: dummyGraph() };
      store = new _LayoutStore['default'](dispatcher, graphStoreMock, { 
        layout: dummyLayout() });});



    it('stores the layout passed at creation', function () {
      var expected = dummyLayout().vertices.get('vA').toJS();
      var actual = store.layout.vertices.get('vA').toJS();
      expect((0, _diff['default'])(expected, actual)).toEqual({});});


    it('handles layout state actions', function () {
      expect(dispatcher.register).
      toHaveBeenCalledWith(_layoutActions.MeasureVertex, any(Function));
      expect(dispatcher.register).
      toHaveBeenCalledWith(_layoutActions.MeasureEdge, any(Function));
      expect(dispatcher.register).
      toHaveBeenCalledWith(_layoutActions.MoveEdge, any(Function));
      expect(dispatcher.register).
      toHaveBeenCalledWith(_layoutActions.MoveVertex, any(Function));
      expect(dispatcher.register).
      toHaveBeenCalledWith(_layoutActions.HandleEdgeInserted, any(Function));
      expect(dispatcher.register).
      toHaveBeenCalledWith(_layoutActions.AutoLayout, any(Function));});


    it('stores its initial state to history', function () {
      expect(dispatcher.dispatch).
      toHaveBeenCalledWith((0, _historyHistoryActions.SaveState)({ 
        storeId: 'LayoutStore', 
        state: _immutable.List.of(dummyLayout(), jasmine.any(Object)) }));});



    describe('asked to store edge measurements', function () {
      beforeEach(function () {
        dispatcher.handleAction((0, _layoutActions.MeasureEdge)({ 
          edge: dummyGraph().edges.get('r0'), 
          measurements: dummyMeasurements().edges.get('r0') }));});



      it('adds that edge to the measurements', function () {
        expect(store.measurements.edges.has('r0')).toBe(true);});});



    describe('asked to remove a complex edge', function () {
      beforeEach(function () {
        dispatcher.handleAction((0, _graphGraphActions.RemoveEdge)({ edgeId: 'r0' }));});


      it('removes that edge from the layout', function () {
        var actual = store.layout.toJS();
        expect(actual.edges.r0).not.toBeDefined();});});




    describe('asked to store vertex measurements', function () {
      beforeEach(function () {
        dispatcher.handleAction((0, _layoutActions.MeasureVertex)({ 
          vertex: dummyGraph().vertices.get('vA'), 
          measurements: dummyMeasurements().vertices.get('vA') }));});



      it('adds that vertex to the measurements', function () {
        expect(store.measurements.vertices.has('vA')).toBe(true);});});



    describe('asked to remove a vertex', function () {
      beforeEach(function () {
        dispatcher.handleAction((0, _graphGraphActions.RemoveVertex)({ vertexId: 'vA' }));});


      it('removes that vertex from the layout', function () {
        expect(store.layout.vertices.has('vA')).toBe(false);});


      it('removes that vertex from the measurements', function () {
        expect(store.measurements.vertices.has('vA')).toBe(false);});});



    describe('asked to move a vertex', function () {
      beforeEach(function () {
        dispatcher.handleAction((0, _layoutActions.MoveVertex)({ 
          vertex: dummyGraph().vertices.get('vA'), 
          to: (0, _layoutModel.Coords)({ left: 17, top: 4 }) }));});



      it('updates that vertices\' coordinates', function () {
        expect(store.layout.vertices.get('vA').toJS()).toEqual({ 
          left: 17, top: 4 });});});




    describe('asked to move an edge', function () {
      beforeEach(function () {
        dispatcher.handleAction((0, _layoutActions.MoveEdge)({ 
          edge: dummyGraph().edges.get('r0'), 
          to: (0, _layoutModel.Coords)({ left: 170, top: 40 }) }));});



      it('updates that edges\' coordinates', function () {
        expect(store.layout.edges.get('r0').toJS()).toEqual({ 
          left: 170, top: 40 });});});




    describe('with measurements for all nodes', function () {

      beforeEach(function () {
        dummyMeasurements().vertices.forEach(function (measurements, vId) {
          var vertex = dummyGraph().vertices.get(vId);
          dispatcher.handleAction((0, _layoutActions.MeasureVertex)({ vertex: vertex, measurements: measurements }));});

        dummyMeasurements().edges.forEach(function (measurements, eId) {
          var edge = dummyGraph().edges.get(eId);
          dispatcher.handleAction((0, _layoutActions.MeasureEdge)({ edge: edge, measurements: measurements }));});});



      describe('asked to remove a vertex', function () {
        beforeEach(function () {
          dispatcher.handleAction((0, _graphGraphActions.RemoveVertex)({ vertexId: 'vA' }));});

        it('removes that vertex from the measurements', function () {
          expect(store.measurements.vertices.has('vA')).toBe(false);});});



      describe('asked to remove a complex edge', function () {
        beforeEach(function () {
          dispatcher.handleAction((0, _graphGraphActions.RemoveEdge)({ edgeId: 'r0' }));});


        it('removes that edge from the measurements', function () {
          var actual = store.measurements.toJS();
          expect(actual.edges.r0).not.toBeDefined();});});



      describe('notified of a newly inserted complex edge', function () {
        beforeEach(function () {
          dispatcher.handleAction((0, _layoutActions.HandleEdgeInserted)({ 
            edge: (0, _graphGraphModel.Edge)({ id: 'r1', type: 'RESOURCE' }), 
            from: (0, _graphGraphModel.Connectable)({ vertexId: 'vA', portId: 'o0', direction: _graphGraphModel.OUT }), 
            to: (0, _graphGraphModel.Connectable)({ vertexId: 'vC', portId: 'i1', direction: _graphGraphModel.IN }) }));});



        it('places it between the ports it connects', function () {
          var edgeOffset = 10;
          var actual = store.layout.toJS();
          expect(actual.edges.r1).toBeDefined();
          expect(actual.edges.r1).toEqual({ 
            left: -edgeOffset + 0.5 * (
            _data2['default'].initial.layout.vertices.vA.left + 
            _data2['default'].initial.measurements.vertices.vA.outbound.o0.left + 
            _data2['default'].initial.layout.vertices.vC.left + 
            _data2['default'].initial.measurements.vertices.vC.inbound.i1.left), 
            top: -edgeOffset + 0.5 * (
            _data2['default'].initial.layout.vertices.vA.top + 
            _data2['default'].initial.measurements.vertices.vA.outbound.o0.top + 
            _data2['default'].initial.layout.vertices.vC.top + 
            _data2['default'].initial.measurements.vertices.vC.inbound.i1.top) });});});});





    describe('called to apply rename rules', function () {
      var result;
      beforeEach(function () {
        var pseudoSelection = _layoutModel.convert.layout({ 
          vertices: { 
            vA: _data2['default'].initial.layout.vertices.vA, 
            vB: _data2['default'].initial.layout.vertices.vB }, 

          edges: { a0: _data2['default'].initial.layout.edges.a0 } });

        var rules = (0, _immutable.Map)({ 
          vertices: (0, _immutable.Map)({ 'vA': 'vA 1' }), 
          edges: (0, _immutable.Map)({ 'a0': 'a0 1' }) });

        result = store.applyRenameRules(pseudoSelection, rules);});


      it('generates an isomorphic layout based on these rules', function () {
        var expected = _layoutModel.convert.layout({ 
          vertices: { 
            'vA 1': _data2['default'].initial.layout.vertices.vA, 
            vB: _data2['default'].initial.layout.vertices.vB }, 

          edges: { 'a0 1': _data2['default'].initial.layout.edges.a0 } }).
        toJS();
        expect((0, _diff['default'])(expected, result.toJS())).toEqual({});});});



    describe('called to insert a disjoint layout', function () {
      beforeEach(function () {
        var pseudoSelection = _layoutModel.convert.layout({ 
          vertices: { vA: _data2['default'].initial.layout.vertices.vA }, 
          edges: { a0: _data2['default'].initial.layout.edges.a0 } });

        var rules = (0, _immutable.Map)({ 
          vertices: (0, _immutable.Map)({ 'vA': 'vA 1' }), 
          edges: (0, _immutable.Map)({ 'a0': 'a0 1' }) });

        var subLayout = store.applyRenameRules(pseudoSelection, rules);
        store.insert(subLayout);});


      it('extends its own layout with the supplied layout', function () {
        var vA1 = copy(_data2['default'].initial.layout.vertices.vA);
        var a01 = copy(_data2['default'].initial.layout.edges.a0);
        var expected = copy(_data2['default'].initial.layout);
        expected.edges['a0 1'] = a01;
        expected.vertices['vA 1'] = vA1;
        expect((0, _diff['default'])(expected, store.layout.toJS())).toEqual({});});});});





  function copy(_) {return JSON.parse(JSON.stringify(_));}});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9mbHV4L2xheW91dC9zcGVjL2xheW91dC1zdG9yZS5zcGVjLmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUE4QkEsV0FBUyxVQUFVLEdBQUc7QUFDcEIsV0FBTyxpQkFiUCxPQUFPLENBYWEsS0FBSyxDQUFFLHNCQUFVLE9BQU8sQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUN0RDs7O0FBRUQsV0FBUyxXQUFXLEdBQUc7QUFDckIsV0FBTyxhQVhBLE9BQU8sQ0FXQyxNQUFNLENBQUUsa0JBQUssT0FBTyxDQUFDLE1BQU0sQ0FBRSxDQUFDLENBQzlDOzs7QUFFRCxXQUFTLGlCQUFpQixHQUFHO0FBQzNCLFdBQU8sYUFmQSxPQUFPLENBZUMsWUFBWSxDQUFFLGtCQUFLLE9BQU8sQ0FBQyxZQUFZLENBQUUsQ0FBQyxDQUMxRDs7Ozs7TUFJTyxPQUFPLEdBQXVDLE1BQU0sQ0FBcEQsT0FBTyxLQUFFLFFBQVEsR0FBNkIsTUFBTSxDQUEzQyxRQUFRLEtBQUUsVUFBVSxHQUFpQixNQUFNLENBQWpDLFVBQVUsS0FBRSxNQUFNLEdBQVMsTUFBTSxDQUFyQixNQUFNLEtBQUUsRUFBRSxHQUFLLE1BQU0sQ0FBYixFQUFFO0FBQ3pDLEtBQUcsR0FBSyxPQUFPLENBQWYsR0FBRzs7QUFFWCxVQUFRLENBQUUsZ0JBQWdCLEVBQUUsWUFBTTs7QUFFaEMsUUFBSSxVQUFVLENBQUM7QUFDZixRQUFJLEtBQUssQ0FBQztBQUNWLFFBQUksY0FBYyxDQUFDOztBQUVuQixjQUFVLENBQUUsWUFBTTtBQUNoQixnQkFBVSxHQUFHLGdDQUFvQixDQUFDO0FBQ2xDLG9CQUFjLEdBQUcsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUUsQ0FBQztBQUN6QyxXQUFLLEdBQUcsNEJBQWlCLFVBQVUsRUFBRSxjQUFjLEVBQUU7QUFDbkQsY0FBTSxFQUFFLFdBQVcsRUFBRSxFQUN0QixDQUFFLENBQUMsQ0FD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QUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFDN0IsQ0FBQyxDQUFDOztBQUNILFlBQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBRSxlQUFlLEVBQUUsS0FBSyxDQUFFLENBQUM7QUFDbkUsYUFBSyxDQUFDLE1BQU0sQ0FBRSxTQUFTLENBQUUsQ0FBQyxDQUMzQixDQUFFLENBQUM7OztBQUVKLFFBQUUsQ0FBRSxpREFBaUQsRUFBRSxZQUFNO0FBQzNELFlBQU0sR0FBRyxHQUFHLElBQUksQ0FBRSxrQkFBSyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUUsQ0FBQztBQUNwRCxZQUFNLEdBQUcsR0FBRyxJQUFJLENBQUUsa0JBQUssT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFFLENBQUM7QUFDakQsWUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFFLGtCQUFLLE9BQU8sQ0FBQyxNQUFNLENBQUUsQ0FBQztBQUM3QyxnQkFBUSxDQUFDLEtBQUssQ0FBRSxNQUFNLENBQUUsR0FBRyxHQUFHLENBQUM7QUFDL0IsZ0JBQVEsQ0FBQyxRQUFRLENBQUUsTUFBTSxDQUFFLEdBQUcsR0FBRyxDQUFDO0FBQ2xDLGNBQU0sQ0FBRSxzQkFBTSxRQUFRLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBRSxDQUFFLENBQUMsT0FBTyxDQUFFLEVBQUUsQ0FBRSxDQUFDLENBQy9ELENBQUUsQ0FBQyxDQUNMLENBQUUsQ0FBQyxDQUVMLENBQUUsQ0FBQzs7Ozs7O0FBRUosV0FBUyxJQUFJLENBQUUsQ0FBQyxFQUFHLENBQUUsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFFLElBQUksQ0FBQyxTQUFTLENBQUUsQ0FBQyxDQUFFLENBQUUsQ0FBQyxDQUFFIiwiZmlsZSI6ImxheW91dC1zdG9yZS5zcGVjLmpzIiwic291cmNlUm9vdCI6InNyYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExpc3QsIE1hcCB9IGZyb20gJ2ltbXV0YWJsZSc7XG5cbmltcG9ydCBMYXlvdXRTdG9yZSBmcm9tICcuLi9sYXlvdXQtc3RvcmUnO1xuaW1wb3J0IERpc3BhdGNoZXJNb2NrIGZyb20gJy4uLy4uLy4uL3Rlc3RpbmcvZGlzcGF0Y2hlci1tb2NrJztcbmltcG9ydCBkaWZmIGZyb20gJy4uLy4uLy4uL3Rlc3RpbmcvZGlmZic7XG5cbmltcG9ydCB7IFJlbW92ZUVkZ2UsIFJlbW92ZVZlcnRleCB9IGZyb20gJy4uLy4uL2dyYXBoL2dyYXBoLWFjdGlvbnMnO1xuaW1wb3J0IHtcbiAgTWVhc3VyZVZlcnRleCxcbiAgTWVhc3VyZUVkZ2UsXG4gIE1vdmVFZGdlLFxuICBNb3ZlVmVydGV4LFxuICBIYW5kbGVFZGdlSW5zZXJ0ZWQsXG4gIEF1dG9MYXlvdXRcbn0gZnJvbSAnLi4vbGF5b3V0LWFjdGlvbnMnO1xuaW1wb3J0IHsgU2F2ZVN0YXRlIH0gZnJvbSAnLi4vLi4vaGlzdG9yeS9oaXN0b3J5LWFjdGlvbnMnO1xuXG5pbXBvcnQge1xuICBjb252ZXJ0IGFzIGdyYXBoQ29udmVydCxcbiAgRWRnZSxcbiAgQ29ubmVjdGFibGUsXG4gIElOLFxuICBPVVRcbn0gZnJvbSAnLi4vLi4vZ3JhcGgvZ3JhcGgtbW9kZWwnO1xuaW1wb3J0IHsgY29udmVydCwgQ29vcmRzIH0gZnJvbSAnLi4vbGF5b3V0LW1vZGVsJztcblxuaW1wb3J0IGRhdGEgZnJvbSAnLi9kYXRhJztcbmltcG9ydCBncmFwaERhdGEgZnJvbSAnLi4vLi4vZ3JhcGgvc3BlYy9kYXRhJztcblxuXG5mdW5jdGlvbiBkdW1teUdyYXBoKCkge1xuICByZXR1cm4gZ3JhcGhDb252ZXJ0LmdyYXBoKCBncmFwaERhdGEuaW5pdGlhbC5ncmFwaCApO1xufVxuXG5mdW5jdGlvbiBkdW1teUxheW91dCgpIHtcbiAgcmV0dXJuIGNvbnZlcnQubGF5b3V0KCBkYXRhLmluaXRpYWwubGF5b3V0ICk7XG59XG5cbmZ1bmN0aW9uIGR1bW15TWVhc3VyZW1lbnRzKCkge1xuICByZXR1cm4gY29udmVydC5tZWFzdXJlbWVudHMoIGRhdGEuaW5pdGlhbC5tZWFzdXJlbWVudHMgKTtcbn1cblxuXG4vLyBKYXNtaW5lOlxuY29uc3QgeyBqYXNtaW5lLCBkZXNjcmliZSwgYmVmb3JlRWFjaCwgZXhwZWN0LCBpdCB9ID0gd2luZG93O1xuY29uc3QgeyBhbnkgfSA9IGphc21pbmU7XG5cbmRlc2NyaWJlKCAnQSBsYXlvdXQgc3RvcmUnLCAoKSA9PiB7XG5cbiAgdmFyIGRpc3BhdGNoZXI7XG4gIHZhciBzdG9yZTtcbiAgdmFyIGdyYXBoU3RvcmVNb2NrO1xuXG4gIGJlZm9yZUVhY2goICgpID0+IHtcbiAgICBkaXNwYXRjaGVyID0gbmV3IERpc3BhdGNoZXJNb2NrKCk7XG4gICAgZ3JhcGhTdG9yZU1vY2sgPSB7IGdyYXBoOiBkdW1teUdyYXBoKCkgfTtcbiAgICBzdG9yZSA9IG5ldyBMYXlvdXRTdG9yZSggZGlzcGF0Y2hlciwgZ3JhcGhTdG9yZU1vY2ssIHtcbiAgICAgIGxheW91dDogZHVtbXlMYXlvdXQoKVxuICAgIH0gKTtcbiAgfSApO1xuXG4gIGl0KCAnc3RvcmVzIHRoZSBsYXlvdXQgcGFzc2VkIGF0IGNyZWF0aW9uJywgKCkgPT4ge1xuICAgIGNvbnN0IGV4cGVjdGVkID0gZHVtbXlMYXlvdXQoKS52ZXJ0aWNlcy5nZXQoICd2QScgKS50b0pTKCk7XG4gICAgY29uc3QgYWN0dWFsID0gc3RvcmUubGF5b3V0LnZlcnRpY2VzLmdldCggJ3ZBJyApLnRvSlMoKTtcbiAgICBleHBlY3QoIGRpZmYoIGV4cGVjdGVkLCBhY3R1YWwgKSApLnRvRXF1YWwoe30pO1xuICB9ICk7XG5cbiAgaXQoICdoYW5kbGVzIGxheW91dCBzdGF0ZSBhY3Rpb25zJywgKCkgPT4ge1xuICAgIGV4cGVjdCggZGlzcGF0Y2hlci5yZWdpc3RlciApXG4gICAgICAudG9IYXZlQmVlbkNhbGxlZFdpdGgoIE1lYXN1cmVWZXJ0ZXgsIGFueSggRnVuY3Rpb24gKSApO1xuICAgIGV4cGVjdCggZGlzcGF0Y2hlci5yZWdpc3RlciApXG4gICAgICAudG9IYXZlQmVlbkNhbGxlZFdpdGgoIE1lYXN1cmVFZGdlLCBhbnkoIEZ1bmN0aW9uICkgKTtcbiAgICBleHBlY3QoIGRpc3BhdGNoZXIucmVnaXN0ZXIgKVxuICAgICAgLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCBNb3ZlRWRnZSwgYW55KCBGdW5jdGlvbiApICk7XG4gICAgZXhwZWN0KCBkaXNwYXRjaGVyLnJlZ2lzdGVyIClcbiAgICAgIC50b0hhdmVCZWVuQ2FsbGVkV2l0aCggTW92ZVZlcnRleCwgYW55KCBGdW5jdGlvbiApICk7XG4gICAgZXhwZWN0KCBkaXNwYXRjaGVyLnJlZ2lzdGVyIClcbiAgICAgIC50b0hhdmVCZWVuQ2FsbGVkV2l0aCggSGFuZGxlRWRnZUluc2VydGVkLCBhbnkoIEZ1bmN0aW9uICkgKTtcbiAgICBleHBlY3QoIGRpc3BhdGNoZXIucmVnaXN0ZXIgKVxuICAgICAgLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCBBdXRvTGF5b3V0LCBhbnkoIEZ1bmN0aW9uICkgKTtcbiAgfSApO1xuXG4gIGl0KCAnc3RvcmVzIGl0cyBpbml0aWFsIHN0YXRlIHRvIGhpc3RvcnknLCAoKSA9PiB7XG4gICAgZXhwZWN0KCBkaXNwYXRjaGVyLmRpc3BhdGNoIClcbiAgICAgIC50b0hhdmVCZWVuQ2FsbGVkV2l0aCggU2F2ZVN0YXRlKHtcbiAgICAgICAgc3RvcmVJZDogJ0xheW91dFN0b3JlJyxcbiAgICAgICAgc3RhdGU6IExpc3Qub2YoIGR1bW15TGF5b3V0KCksIGphc21pbmUuYW55KCBPYmplY3QgKSApXG4gICAgICB9KSApO1xuICB9ICk7XG5cbiAgZGVzY3JpYmUoICdhc2tlZCB0byBzdG9yZSBlZGdlIG1lYXN1cmVtZW50cycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBkaXNwYXRjaGVyLmhhbmRsZUFjdGlvbiggTWVhc3VyZUVkZ2Uoe1xuICAgICAgICBlZGdlOiBkdW1teUdyYXBoKCkuZWRnZXMuZ2V0KCAncjAnICksXG4gICAgICAgIG1lYXN1cmVtZW50czogZHVtbXlNZWFzdXJlbWVudHMoKS5lZGdlcy5nZXQoICdyMCcgKVxuICAgICAgfSkgKTtcbiAgICB9ICk7XG5cbiAgICBpdCggJ2FkZHMgdGhhdCBlZGdlIHRvIHRoZSBtZWFzdXJlbWVudHMnLCAoKSA9PiB7XG4gICAgICBleHBlY3QoIHN0b3JlLm1lYXN1cmVtZW50cy5lZGdlcy5oYXMoICdyMCcgKSApLnRvQmUoIHRydWUgKTtcbiAgICB9ICk7XG4gIH0gKTtcblxuICBkZXNjcmliZSggJ2Fza2VkIHRvIHJlbW92ZSBhIGNvbXBsZXggZWRnZScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBkaXNwYXRjaGVyLmhhbmRsZUFjdGlvbiggUmVtb3ZlRWRnZSh7IGVkZ2VJZDogJ3IwJyB9KSApO1xuICAgIH0gKTtcblxuICAgIGl0KCAncmVtb3ZlcyB0aGF0IGVkZ2UgZnJvbSB0aGUgbGF5b3V0JywgKCkgPT4ge1xuICAgICAgY29uc3QgYWN0dWFsID0gc3RvcmUubGF5b3V0LnRvSlMoKTtcbiAgICAgIGV4cGVjdCggYWN0dWFsLmVkZ2VzLnIwICkubm90LnRvQmVEZWZpbmVkKCk7XG4gICAgfSApO1xuXG4gIH0gKTtcblxuICBkZXNjcmliZSggJ2Fza2VkIHRvIHN0b3JlIHZlcnRleCBtZWFzdXJlbWVudHMnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCggKCkgPT4ge1xuICAgICAgZGlzcGF0Y2hlci5oYW5kbGVBY3Rpb24oIE1lYXN1cmVWZXJ0ZXgoe1xuICAgICAgICB2ZXJ0ZXg6IGR1bW15R3JhcGgoKS52ZXJ0aWNlcy5nZXQoICd2QScgKSxcbiAgICAgICAgbWVhc3VyZW1lbnRzOiBkdW1teU1lYXN1cmVtZW50cygpLnZlcnRpY2VzLmdldCggJ3ZBJyApXG4gICAgICB9KSApO1xuICAgIH0gKTtcblxuICAgIGl0KCAnYWRkcyB0aGF0IHZlcnRleCB0byB0aGUgbWVhc3VyZW1lbnRzJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KCBzdG9yZS5tZWFzdXJlbWVudHMudmVydGljZXMuaGFzKCAndkEnICkgKS50b0JlKCB0cnVlICk7XG4gICAgfSApO1xuICB9ICk7XG5cbiAgZGVzY3JpYmUoICdhc2tlZCB0byByZW1vdmUgYSB2ZXJ0ZXgnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCggKCkgPT4ge1xuICAgICAgZGlzcGF0Y2hlci5oYW5kbGVBY3Rpb24oIFJlbW92ZVZlcnRleCh7IHZlcnRleElkOiAndkEnIH0pICk7XG4gICAgfSApO1xuXG4gICAgaXQoICdyZW1vdmVzIHRoYXQgdmVydGV4IGZyb20gdGhlIGxheW91dCcsICgpID0+IHtcbiAgICAgIGV4cGVjdCggc3RvcmUubGF5b3V0LnZlcnRpY2VzLmhhcyggJ3ZBJyApICkudG9CZSggZmFsc2UgKTtcbiAgICB9ICk7XG5cbiAgICBpdCggJ3JlbW92ZXMgdGhhdCB2ZXJ0ZXggZnJvbSB0aGUgbWVhc3VyZW1lbnRzJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KCBzdG9yZS5tZWFzdXJlbWVudHMudmVydGljZXMuaGFzKCAndkEnICkgKS50b0JlKCBmYWxzZSApO1xuICAgIH0gKTtcbiAgfSApO1xuXG4gIGRlc2NyaWJlKCAnYXNrZWQgdG8gbW92ZSBhIHZlcnRleCcsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBkaXNwYXRjaGVyLmhhbmRsZUFjdGlvbiggTW92ZVZlcnRleCh7XG4gICAgICAgIHZlcnRleDogZHVtbXlHcmFwaCgpLnZlcnRpY2VzLmdldCggJ3ZBJyApLFxuICAgICAgICB0bzogQ29vcmRzKHsgbGVmdDogMTcsIHRvcDogNCB9KVxuICAgICAgfSkgKTtcbiAgICB9ICk7XG5cbiAgICBpdCggJ3VwZGF0ZXMgdGhhdCB2ZXJ0aWNlc1xcJyBjb29yZGluYXRlcycsICgpID0+IHtcbiAgICAgIGV4cGVjdCggc3RvcmUubGF5b3V0LnZlcnRpY2VzLmdldCggJ3ZBJyApLnRvSlMoKSApLnRvRXF1YWwoe1xuICAgICAgICBsZWZ0OiAxNywgdG9wOiA0XG4gICAgICB9KTtcbiAgICB9ICk7XG4gIH0gKTtcblxuICBkZXNjcmliZSggJ2Fza2VkIHRvIG1vdmUgYW4gZWRnZScsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBkaXNwYXRjaGVyLmhhbmRsZUFjdGlvbiggTW92ZUVkZ2Uoe1xuICAgICAgICBlZGdlOiBkdW1teUdyYXBoKCkuZWRnZXMuZ2V0KCAncjAnICksXG4gICAgICAgIHRvOiBDb29yZHMoeyBsZWZ0OiAxNzAsIHRvcDogNDAgfSlcbiAgICAgIH0pICk7XG4gICAgfSApO1xuXG4gICAgaXQoICd1cGRhdGVzIHRoYXQgZWRnZXNcXCcgY29vcmRpbmF0ZXMnLCAoKSA9PiB7XG4gICAgICBleHBlY3QoIHN0b3JlLmxheW91dC5lZGdlcy5nZXQoICdyMCcgKS50b0pTKCkgKS50b0VxdWFsKHtcbiAgICAgICAgbGVmdDogMTcwLCB0b3A6IDQwXG4gICAgICB9KTtcbiAgICB9ICk7XG4gIH0gKTtcblxuICBkZXNjcmliZSggJ3dpdGggbWVhc3VyZW1lbnRzIGZvciBhbGwgbm9kZXMnLCAoKSA9PiB7XG5cbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBkdW1teU1lYXN1cmVtZW50cygpLnZlcnRpY2VzLmZvckVhY2goIChtZWFzdXJlbWVudHMsIHZJZCkgPT4ge1xuICAgICAgICBjb25zdCB2ZXJ0ZXggPSBkdW1teUdyYXBoKCkudmVydGljZXMuZ2V0KCB2SWQgKTtcbiAgICAgICAgZGlzcGF0Y2hlci5oYW5kbGVBY3Rpb24oIE1lYXN1cmVWZXJ0ZXgoeyB2ZXJ0ZXgsIG1lYXN1cmVtZW50cyB9KSApO1xuICAgICAgfSk7XG4gICAgICBkdW1teU1lYXN1cmVtZW50cygpLmVkZ2VzLmZvckVhY2goIChtZWFzdXJlbWVudHMsIGVJZCkgPT4ge1xuICAgICAgICBjb25zdCBlZGdlID0gZHVtbXlHcmFwaCgpLmVkZ2VzLmdldCggZUlkICk7XG4gICAgICAgIGRpc3BhdGNoZXIuaGFuZGxlQWN0aW9uKCBNZWFzdXJlRWRnZSh7IGVkZ2UsIG1lYXN1cmVtZW50cyB9KSApO1xuICAgICAgfSk7XG4gICAgfSApO1xuXG4gICAgZGVzY3JpYmUoICdhc2tlZCB0byByZW1vdmUgYSB2ZXJ0ZXgnLCAoKSA9PiB7XG4gICAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICAgIGRpc3BhdGNoZXIuaGFuZGxlQWN0aW9uKCBSZW1vdmVWZXJ0ZXgoeyB2ZXJ0ZXhJZDogJ3ZBJyB9KSApO1xuICAgICAgfSApO1xuICAgICAgaXQoICdyZW1vdmVzIHRoYXQgdmVydGV4IGZyb20gdGhlIG1lYXN1cmVtZW50cycsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KCBzdG9yZS5tZWFzdXJlbWVudHMudmVydGljZXMuaGFzKCAndkEnICkgKS50b0JlKCBmYWxzZSApO1xuICAgICAgfSApO1xuICAgIH0gKTtcblxuICAgIGRlc2NyaWJlKCAnYXNrZWQgdG8gcmVtb3ZlIGEgY29tcGxleCBlZGdlJywgKCkgPT4ge1xuICAgICAgYmVmb3JlRWFjaCggKCkgPT4ge1xuICAgICAgICBkaXNwYXRjaGVyLmhhbmRsZUFjdGlvbiggUmVtb3ZlRWRnZSh7IGVkZ2VJZDogJ3IwJyB9KSApO1xuICAgICAgfSApO1xuXG4gICAgICBpdCggJ3JlbW92ZXMgdGhhdCBlZGdlIGZyb20gdGhlIG1lYXN1cmVtZW50cycsICgpID0+IHtcbiAgICAgICAgY29uc3QgYWN0dWFsID0gc3RvcmUubWVhc3VyZW1lbnRzLnRvSlMoKTtcbiAgICAgICAgZXhwZWN0KCBhY3R1YWwuZWRnZXMucjAgKS5ub3QudG9CZURlZmluZWQoKTtcbiAgICAgIH0gKTtcbiAgICB9ICk7XG5cbiAgICBkZXNjcmliZSggJ25vdGlmaWVkIG9mIGEgbmV3bHkgaW5zZXJ0ZWQgY29tcGxleCBlZGdlJywgKCkgPT4ge1xuICAgICAgYmVmb3JlRWFjaCggKCkgPT4ge1xuICAgICAgICBkaXNwYXRjaGVyLmhhbmRsZUFjdGlvbiggSGFuZGxlRWRnZUluc2VydGVkKHtcbiAgICAgICAgICBlZGdlOiBFZGdlKHsgaWQ6ICdyMScsIHR5cGU6ICdSRVNPVVJDRScgfSksXG4gICAgICAgICAgZnJvbTogQ29ubmVjdGFibGUoeyB2ZXJ0ZXhJZDogJ3ZBJywgcG9ydElkOiAnbzAnLCBkaXJlY3Rpb246IE9VVCB9KSxcbiAgICAgICAgICB0bzogQ29ubmVjdGFibGUoeyB2ZXJ0ZXhJZDogJ3ZDJywgcG9ydElkOiAnaTEnLCBkaXJlY3Rpb246IElOIH0pXG4gICAgICAgIH0pICk7XG4gICAgICB9ICk7XG5cbiAgICAgIGl0KCAncGxhY2VzIGl0IGJldHdlZW4gdGhlIHBvcnRzIGl0IGNvbm5lY3RzJywgKCkgPT4ge1xuICAgICAgICBjb25zdCBlZGdlT2Zmc2V0ID0gMTA7XG4gICAgICAgIGNvbnN0IGFjdHVhbCA9IHN0b3JlLmxheW91dC50b0pTKCk7XG4gICAgICAgIGV4cGVjdCggYWN0dWFsLmVkZ2VzLnIxICkudG9CZURlZmluZWQoKTtcbiAgICAgICAgZXhwZWN0KCBhY3R1YWwuZWRnZXMucjEgKS50b0VxdWFsKHtcbiAgICAgICAgICBsZWZ0OiAtZWRnZU9mZnNldCArIDAuNSAqIChcbiAgICAgICAgICAgIGRhdGEuaW5pdGlhbC5sYXlvdXQudmVydGljZXMudkEubGVmdCArXG4gICAgICAgICAgICBkYXRhLmluaXRpYWwubWVhc3VyZW1lbnRzLnZlcnRpY2VzLnZBLm91dGJvdW5kLm8wLmxlZnQgK1xuICAgICAgICAgICAgZGF0YS5pbml0aWFsLmxheW91dC52ZXJ0aWNlcy52Qy5sZWZ0ICtcbiAgICAgICAgICAgIGRhdGEuaW5pdGlhbC5tZWFzdXJlbWVudHMudmVydGljZXMudkMuaW5ib3VuZC5pMS5sZWZ0ICksXG4gICAgICAgICAgdG9wOiAtZWRnZU9mZnNldCArIDAuNSAqIChcbiAgICAgICAgICAgIGRhdGEuaW5pdGlhbC5sYXlvdXQudmVydGljZXMudkEudG9wICtcbiAgICAgICAgICAgIGRhdGEuaW5pdGlhbC5tZWFzdXJlbWVudHMudmVydGljZXMudkEub3V0Ym91bmQubzAudG9wICtcbiAgICAgICAgICAgIGRhdGEuaW5pdGlhbC5sYXlvdXQudmVydGljZXMudkMudG9wICtcbiAgICAgICAgICAgIGRhdGEuaW5pdGlhbC5tZWFzdXJlbWVudHMudmVydGljZXMudkMuaW5ib3VuZC5pMS50b3AgKVxuICAgICAgICB9KTtcbiAgICAgIH0gKTtcbiAgICB9ICk7XG4gIH0gKTtcblxuICBkZXNjcmliZSggJ2NhbGxlZCB0byBhcHBseSByZW5hbWUgcnVsZXMnLCAoKSA9PiB7XG4gICAgdmFyIHJlc3VsdDtcbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBjb25zdCBwc2V1ZG9TZWxlY3Rpb24gPSBjb252ZXJ0LmxheW91dCh7XG4gICAgICAgIHZlcnRpY2VzOiB7XG4gICAgICAgICAgdkE6IGRhdGEuaW5pdGlhbC5sYXlvdXQudmVydGljZXMudkEsXG4gICAgICAgICAgdkI6IGRhdGEuaW5pdGlhbC5sYXlvdXQudmVydGljZXMudkJcbiAgICAgICAgfSxcbiAgICAgICAgZWRnZXM6IHsgYTA6IGRhdGEuaW5pdGlhbC5sYXlvdXQuZWRnZXMuYTAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBydWxlcyA9IE1hcCh7XG4gICAgICAgIHZlcnRpY2VzOiBNYXAoeyAndkEnOiAndkEgMScgfSksXG4gICAgICAgIGVkZ2VzOiBNYXAoeyAnYTAnOiAnYTAgMScgfSlcbiAgICAgIH0pO1xuICAgICAgcmVzdWx0ID0gc3RvcmUuYXBwbHlSZW5hbWVSdWxlcyggcHNldWRvU2VsZWN0aW9uLCBydWxlcyApO1xuICAgIH0gKTtcblxuICAgIGl0KCAnZ2VuZXJhdGVzIGFuIGlzb21vcnBoaWMgbGF5b3V0IGJhc2VkIG9uIHRoZXNlIHJ1bGVzJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXhwZWN0ZWQgPSBjb252ZXJ0LmxheW91dCh7XG4gICAgICAgIHZlcnRpY2VzOiB7XG4gICAgICAgICAgJ3ZBIDEnOiBkYXRhLmluaXRpYWwubGF5b3V0LnZlcnRpY2VzLnZBLFxuICAgICAgICAgIHZCOiBkYXRhLmluaXRpYWwubGF5b3V0LnZlcnRpY2VzLnZCXG4gICAgICAgIH0sXG4gICAgICAgIGVkZ2VzOiB7ICdhMCAxJzogZGF0YS5pbml0aWFsLmxheW91dC5lZGdlcy5hMCB9XG4gICAgICB9KS50b0pTKCk7XG4gICAgICBleHBlY3QoIGRpZmYoIGV4cGVjdGVkLCByZXN1bHQudG9KUygpICkgKS50b0VxdWFsKCB7fSApO1xuICAgIH0gKTtcbiAgfSApO1xuXG4gIGRlc2NyaWJlKCAnY2FsbGVkIHRvIGluc2VydCBhIGRpc2pvaW50IGxheW91dCcsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCAoKSA9PiB7XG4gICAgICBjb25zdCBwc2V1ZG9TZWxlY3Rpb24gPSBjb252ZXJ0LmxheW91dCh7XG4gICAgICAgIHZlcnRpY2VzOiB7IHZBOiBkYXRhLmluaXRpYWwubGF5b3V0LnZlcnRpY2VzLnZBIH0sXG4gICAgICAgIGVkZ2VzOiB7IGEwOiBkYXRhLmluaXRpYWwubGF5b3V0LmVkZ2VzLmEwIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3QgcnVsZXMgPSBNYXAoe1xuICAgICAgICB2ZXJ0aWNlczogTWFwKHsgJ3ZBJzogJ3ZBIDEnIH0pLFxuICAgICAgICBlZGdlczogTWFwKHsgJ2EwJzogJ2EwIDEnIH0pXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHN1YkxheW91dCA9IHN0b3JlLmFwcGx5UmVuYW1lUnVsZXMoIHBzZXVkb1NlbGVjdGlvbiwgcnVsZXMgKTtcbiAgICAgIHN0b3JlLmluc2VydCggc3ViTGF5b3V0ICk7XG4gICAgfSApO1xuXG4gICAgaXQoICdleHRlbmRzIGl0cyBvd24gbGF5b3V0IHdpdGggdGhlIHN1cHBsaWVkIGxheW91dCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHZBMSA9IGNvcHkoIGRhdGEuaW5pdGlhbC5sYXlvdXQudmVydGljZXMudkEgKTtcbiAgICAgIGNvbnN0IGEwMSA9IGNvcHkoIGRhdGEuaW5pdGlhbC5sYXlvdXQuZWRnZXMuYTAgKTtcbiAgICAgIGNvbnN0IGV4cGVjdGVkID0gY29weSggZGF0YS5pbml0aWFsLmxheW91dCApO1xuICAgICAgZXhwZWN0ZWQuZWRnZXNbICdhMCAxJyBdID0gYTAxO1xuICAgICAgZXhwZWN0ZWQudmVydGljZXNbICd2QSAxJyBdID0gdkExO1xuICAgICAgZXhwZWN0KCBkaWZmKCBleHBlY3RlZCwgc3RvcmUubGF5b3V0LnRvSlMoKSApICkudG9FcXVhbCgge30gKTtcbiAgICB9ICk7XG4gIH0gKTtcblxufSApO1xuXG5mdW5jdGlvbiBjb3B5KCBfICkgeyByZXR1cm4gSlNPTi5wYXJzZSggSlNPTi5zdHJpbmdpZnkoIF8gKSApOyB9XG4iXX0=