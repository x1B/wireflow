define(['exports', 'module', 'immutable', '../history/history-actions', '../layout/layout-actions', './graph-model', './graph-actions'], function (exports, module, _immutable, _historyHistoryActions, _layoutLayoutActions, _graphModel, _graphActions) {'use strict';var _createClass = (function () {function defineProperties(target, props) {for (var i = 0; i < props.length; i++) {var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ('value' in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);}}return function (Constructor, protoProps, staticProps) {if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;};})();function _classCallCheck(instance, Constructor) {if (!(instance instanceof Constructor)) {throw new TypeError('Cannot call a class as a function');}}













  /**
   * Manages the graph model prop.
   */var 
  GraphStore = (function () {

    function GraphStore(dispatcher, graph, types) {var _this = this;_classCallCheck(this, GraphStore);
      this.dispatcher = dispatcher;

      this.storeId = this.constructor.name;
      this.graph = graph;
      this.types = types;
      this.save();

      dispatcher.register(_graphActions.DisconnectPort, function (act) {
        _this.disconnect(act.vertex, act.port);
        _this.save();});


      dispatcher.register(_graphActions.ConnectPort, function (act) {
        _this.connect(act.from, act.to);
        _this.save();});


      dispatcher.register(_graphActions.RemoveVertex, function (act) {
        _this.removeVertex(act.vertexId);
        _this.save();});


      dispatcher.register(_graphActions.RemoveEdge, function (act) {
        _this.removeEdge(act.edgeId);
        _this.save();});


      dispatcher.register(_historyHistoryActions.RestoreState, function (act) {
        if (act.storeId === _this.storeId) {
          _this.graph = act.state.get(0);
          _this.types = act.state.get(1);}});}_createClass(GraphStore, [{ key: 'save', value: 





      function save() {
        this.dispatcher.dispatch((0, _historyHistoryActions.SaveState)({ 
          storeId: this.storeId, 
          state: _immutable.List.of(this.graph, this.types) }));} }, { key: 'connect', value: 



      function connect(from, to) {
        if (to.edgeId) {
          this.setPortEdge(from, to.edgeId);
          return;}


        var newEdgeId = nextId(this.graph.edges);
        var newEdge = (0, _graphModel.Edge)({ id: newEdgeId, label: 'aaaa', type: from.type });
        this.graph = this.graph.setIn(['edges', newEdgeId], newEdge);
        this.setPortEdge(from, newEdgeId);
        this.setPortEdge(to, newEdgeId);
        this.pruneEmptyEdges();

        this.dispatcher.dispatch((0, _layoutLayoutActions.HandleEdgeInserted)({ 
          edge: newEdge, 
          from: from, 
          to: to }));


        function nextId(someMap) {
          var prefix = '#' + someMap.size;
          var qualified = function qualified(c) {return c ? prefix : prefix + '/' + c;};
          var counter = 0;
          while (someMap.has(qualified(counter))) {++counter;}
          return qualified(counter);}} }, { key: 'setPortEdge', value: 



      function setPortEdge(from, edgeId) {
        var portsPath = ['vertices', from.vertexId, 'ports', from.direction];
        this.graph = this.graph.updateIn(portsPath, function (ports) {return ports.map(function (p) {return (
              p.id === from.portId ? p.set('edgeId', edgeId) : p);});});} }, { key: 'disconnect', value: 



      function disconnect(vertex, port) {
        var portsPath = ['vertices', vertex.id, 'ports', port.direction];

        var type = this.types.get(port.type);
        if (type.owningPort === port.direction) {
          this.removeEdge(port.edgeId);
          return;}


        var current = this.graph;
        this.graph = current.
        setIn(portsPath, current.getIn(portsPath).map(function (p) {
          return p.id !== port.id ? p : port.set('edgeId', null);}));

        this.pruneEmptyEdges();} }, { key: 'removeEdge', value: 


      function removeEdge(edgeId) {
        this.disconnectAll(edgeId);
        this.pruneEmptyEdges();} }, { key: 'removeVertex', value: 


      function removeVertex(vertexId) {var _this2 = this;
        var vertex = this.graph.vertices.get(vertexId);
        _graphModel.Directions.flatMap(function (d) {return vertex.ports[d];}).forEach(function (port) {
          _this2.disconnect(vertex, port);});


        this.graph = this.graph.update('vertices', function (vs) {return (
            vs.filter(function (v) {return v.id !== vertexId;}));});
        this.pruneEmptyEdges();} }, { key: 'disconnectAll', value: 


      function disconnectAll(edgeId) {
        this.graph = mapGraphPorts(this.graph, function (p) {return p.set('edgeId', 
          p.edgeId === edgeId ? null : p.edgeId);});} }, { key: 'pruneEmptyEdges', value: 



      function pruneEmptyEdges() {var _this3 = this;
        var portsByEdge = this.graph.vertices.valueSeq().
        flatMap(function (v) {return _graphModel.Directions.flatMap(function (d) {return v.ports[d];});}).
        filter(function (p) {return p.edgeId != null;}).
        groupBy(function (p) {return p.edgeId;});

        var isSimple = function isSimple(e) {return _this3.types.get(e.type).owningPort !== null;};

        var toPrune = this.graph.edges.filter(function (e) {
          var edgePorts = portsByEdge.get(e.id);
          return !edgePorts || edgePorts.size <= (isSimple(e) ? 1 : 0);});


        toPrune.forEach(function (e) {return _this3.disconnectAll(e.id);});

        this.graph = this.graph.set('edges', 
        this.graph.edges.filter(function (e) {return !toPrune.has(e.id);}));}




      // pure helpers
    }, { key: 'renameRules', value: 
      function renameRules(newGraph) {
        return (0, _immutable.Map)({ 
          edges: renameRules(this.graph.edges, newGraph.edges), 
          vertices: renameRules(this.graph.vertices, newGraph.vertices) });


        function renameRules(existingMap, newMap) {
          var jsExistingKeys = existingMap.toJS();
          var takenKeys = {};
          var rules = {};
          newMap.forEach(function (_, key) {
            var newKey = disjointKey(
            takenKeys, 
            disjointKey(jsExistingKeys, key));

            rules[key] = newKey;
            takenKeys[newKey] = true;});

          return (0, _immutable.Map)(rules);}


        function disjointKey(_x, _x2) {var _again = true;_function: while (_again) {var jsMap = _x, key = _x2;_again = false;
            var matcher = /^(.*) ([0-9]+)$/;
            if (!jsMap.hasOwnProperty(key)) {
              return key;}

            if (!matcher.test(key)) {_x = 
              jsMap;_x2 = key + ' 1';_again = true;matcher = undefined;continue _function;}

            var number = 1 + parseInt(key.replace(matcher, '$2'), 10);_x = 
            jsMap;_x2 = key.replace(matcher, '$1') + ' ' + number;_again = true;matcher = number = undefined;continue _function;}}} }, { key: 'applyRenameRules', value: 



      function applyRenameRules(newGraph, renameRules) {
        var edgeRules = renameRules.get('edges');
        var vertexRules = renameRules.get('vertices');
        var edges = {};
        newGraph.edges.forEach(function (edge, eId) {
          var newId = edgeRules.get(eId);
          edges[newId] = edge.setIn(['id'], newId);});

        var vertices = {};
        newGraph.vertices.forEach(function (vertex, vId) {
          var newId = vertexRules.get(vId) || vertex.id;
          vertices[newId] = vertex.setIn(['id'], newId);});

        return mapGraphPorts(
        (0, _graphModel.Graph)({ edges: (0, _immutable.Map)(edges), vertices: (0, _immutable.Map)(vertices) }), 
        function (p) {return p.set('edgeId', 
          p.edgeId && edgeRules.get(p.edgeId) || p.edgeId || null);});} }, { key: 'insert', value: 




      function insert(newGraph, renameRules) {
        var disjointGraph = renameRules ? 
        this.applyRenameRules(newGraph, renameRules) : 
        newGraph;

        this.graph = this.graph.
        set('edges', this.graph.edges.merge(disjointGraph.edges)).
        set('vertices', this.graph.vertices.merge(disjointGraph.vertices));} }]);return GraphStore;})();module.exports = 



  GraphStore;


  function mapVertexPorts(v, f) {
    return v.set('ports', (0, _graphModel.Ports)({ 
      inbound: v.ports.inbound.map(f), 
      outbound: v.ports.outbound.map(f) }));}



  function mapVertices(graph, f) {
    return graph.setIn(['vertices'], graph.vertices.map(f));}


  function mapGraphPorts(graph, f) {
    return mapVertices(graph, function (v) {return mapVertexPorts(v, f);});}});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9mbHV4L2dyYXBoL2dyYXBoLXN0b3JlLmpzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQWlCTSxZQUFVOztBQUVILGFBRlAsVUFBVSxDQUVELFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFHLHdDQUZwQyxVQUFVO0FBR1osVUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7O0FBRTdCLFVBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7QUFDckMsVUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7QUFDbkIsVUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7QUFDbkIsVUFBSSxDQUFDLElBQUksRUFBRSxDQUFDOztBQUVaLGdCQUFVLENBQUMsUUFBUSxlQXBCckIsY0FBYyxFQW9CeUIsVUFBQSxHQUFHLEVBQUk7QUFDMUMsY0FBSyxVQUFVLENBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFFLENBQUM7QUFDeEMsY0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUNiLENBQUUsQ0FBQzs7O0FBRUosZ0JBQVUsQ0FBQyxRQUFRLGVBeEJyQixXQUFXLEVBd0J5QixVQUFBLEdBQUcsRUFBSTtBQUN2QyxjQUFLLE9BQU8sQ0FBRSxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUUsQ0FBQztBQUNqQyxjQUFLLElBQUksRUFBRSxDQUFDLENBQ2IsQ0FBRSxDQUFDOzs7QUFFSixnQkFBVSxDQUFDLFFBQVEsZUE1QnJCLFlBQVksRUE0QnlCLFVBQUEsR0FBRyxFQUFJO0FBQ3hDLGNBQUssWUFBWSxDQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUUsQ0FBQztBQUNsQyxjQUFLLElBQUksRUFBRSxDQUFDLENBQ2IsQ0FBRSxDQUFDOzs7QUFFSixnQkFBVSxDQUFDLFFBQVEsZUFoQ3JCLFVBQVUsRUFnQ3lCLFVBQUEsR0FBRyxF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QUFTLFdBQVcsQ0FBRSxLQUFLLEVBQUUsQ0FBQyxFQUFHO0FBQy9CLFdBQU8sS0FBSyxDQUFDLEtBQUssQ0FBRSxDQUFFLFVBQVUsQ0FBRSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFFLENBQUMsQ0FBRSxDQUFFLENBQUMsQ0FDL0Q7OztBQUVELFdBQVMsYUFBYSxDQUFFLEtBQUssRUFBRSxDQUFDLEVBQUc7QUFDakMsV0FBTyxXQUFXLENBQUUsS0FBSyxFQUFFLFVBQUEsQ0FBQyxVQUFJLGNBQWMsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFFLEVBQUEsQ0FBRSxDQUFDLENBQzFEIiwiZmlsZSI6ImdyYXBoLXN0b3JlLmpzIiwic291cmNlUm9vdCI6InNyYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExpc3QsIE1hcCB9IGZyb20gJ2ltbXV0YWJsZSc7XG5cbmltcG9ydCB7IFNhdmVTdGF0ZSwgUmVzdG9yZVN0YXRlIH0gZnJvbSAnLi4vaGlzdG9yeS9oaXN0b3J5LWFjdGlvbnMnO1xuaW1wb3J0IHsgSGFuZGxlRWRnZUluc2VydGVkIH0gZnJvbSAnLi4vbGF5b3V0L2xheW91dC1hY3Rpb25zJztcblxuaW1wb3J0IHsgRGlyZWN0aW9ucywgUG9ydHMsIEVkZ2UsIEdyYXBoIH0gZnJvbSAnLi9ncmFwaC1tb2RlbCc7XG5pbXBvcnQge1xuICBEaXNjb25uZWN0UG9ydCxcbiAgQ29ubmVjdFBvcnQsXG4gIFJlbW92ZVZlcnRleCxcbiAgUmVtb3ZlRWRnZVxufSBmcm9tICcuL2dyYXBoLWFjdGlvbnMnO1xuXG5cbi8qKlxuICogTWFuYWdlcyB0aGUgZ3JhcGggbW9kZWwgcHJvcC5cbiAqL1xuY2xhc3MgR3JhcGhTdG9yZSB7XG5cbiAgY29uc3RydWN0b3IoIGRpc3BhdGNoZXIsIGdyYXBoLCB0eXBlcyApIHtcbiAgICB0aGlzLmRpc3BhdGNoZXIgPSBkaXNwYXRjaGVyO1xuXG4gICAgdGhpcy5zdG9yZUlkID0gdGhpcy5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgIHRoaXMuZ3JhcGggPSBncmFwaDtcbiAgICB0aGlzLnR5cGVzID0gdHlwZXM7XG4gICAgdGhpcy5zYXZlKCk7XG5cbiAgICBkaXNwYXRjaGVyLnJlZ2lzdGVyKCBEaXNjb25uZWN0UG9ydCwgYWN0ID0+IHtcbiAgICAgIHRoaXMuZGlzY29ubmVjdCggYWN0LnZlcnRleCwgYWN0LnBvcnQgKTtcbiAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH0gKTtcblxuICAgIGRpc3BhdGNoZXIucmVnaXN0ZXIoIENvbm5lY3RQb3J0LCBhY3QgPT4ge1xuICAgICAgdGhpcy5jb25uZWN0KCBhY3QuZnJvbSwgYWN0LnRvICk7XG4gICAgICB0aGlzLnNhdmUoKTtcbiAgICB9ICk7XG5cbiAgICBkaXNwYXRjaGVyLnJlZ2lzdGVyKCBSZW1vdmVWZXJ0ZXgsIGFjdCA9PiB7XG4gICAgICB0aGlzLnJlbW92ZVZlcnRleCggYWN0LnZlcnRleElkICk7XG4gICAgICB0aGlzLnNhdmUoKTtcbiAgICB9ICk7XG5cbiAgICBkaXNwYXRjaGVyLnJlZ2lzdGVyKCBSZW1vdmVFZGdlLCBhY3QgPT4ge1xuICAgICAgdGhpcy5yZW1vdmVFZGdlKCBhY3QuZWRnZUlkICk7XG4gICAgICB0aGlzLnNhdmUoKTtcbiAgICB9ICk7XG5cbiAgICBkaXNwYXRjaGVyLnJlZ2lzdGVyKCBSZXN0b3JlU3RhdGUsIGFjdCA9PiB7XG4gICAgICBpZiggYWN0LnN0b3JlSWQgPT09IHRoaXMuc3RvcmVJZCApIHtcbiAgICAgICAgdGhpcy5ncmFwaCA9IGFjdC5zdGF0ZS5nZXQoMCk7XG4gICAgICAgIHRoaXMudHlwZXMgPSBhY3Quc3RhdGUuZ2V0KDEpO1xuICAgICAgfVxuICAgIH0gKTtcblxuICB9XG5cbiAgc2F2ZSgpIHtcbiAgICB0aGlzLmRpc3BhdGNoZXIuZGlzcGF0Y2goIFNhdmVTdGF0ZSh7XG4gICAgICBzdG9yZUlkOiB0aGlzLnN0b3JlSWQsXG4gICAgICBzdGF0ZTogTGlzdC5vZiggdGhpcy5ncmFwaCwgdGhpcy50eXBlcyApXG4gICAgfSkgKTtcbiAgfVxuXG4gIGNvbm5lY3QoIGZyb20sIHRvICkge1xuICAgIGlmKCB0by5lZGdlSWQgKSB7XG4gICAgICB0aGlzLnNldFBvcnRFZGdlKCBmcm9tLCB0by5lZGdlSWQgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdFZGdlSWQgPSBuZXh0SWQoIHRoaXMuZ3JhcGguZWRnZXMgKTtcbiAgICBjb25zdCBuZXdFZGdlID0gRWRnZSh7IGlkOiBuZXdFZGdlSWQsIGxhYmVsOiAnYWFhYScsIHR5cGU6IGZyb20udHlwZSB9KTtcbiAgICB0aGlzLmdyYXBoID0gdGhpcy5ncmFwaC5zZXRJbiggWyAnZWRnZXMnLCBuZXdFZGdlSWQgXSwgbmV3RWRnZSApO1xuICAgIHRoaXMuc2V0UG9ydEVkZ2UoIGZyb20sIG5ld0VkZ2VJZCApO1xuICAgIHRoaXMuc2V0UG9ydEVkZ2UoIHRvLCBuZXdFZGdlSWQgKTtcbiAgICB0aGlzLnBydW5lRW1wdHlFZGdlcygpO1xuXG4gICAgdGhpcy5kaXNwYXRjaGVyLmRpc3BhdGNoKCBIYW5kbGVFZGdlSW5zZXJ0ZWQoe1xuICAgICAgZWRnZTogbmV3RWRnZSxcbiAgICAgIGZyb206IGZyb20sXG4gICAgICB0bzogdG9cbiAgICB9KSApO1xuXG4gICAgZnVuY3Rpb24gbmV4dElkKCBzb21lTWFwICkge1xuICAgICAgY29uc3QgcHJlZml4ID0gJyMnICsgc29tZU1hcC5zaXplO1xuICAgICAgY29uc3QgcXVhbGlmaWVkID0gYyA9PiBjID8gcHJlZml4IDogKHByZWZpeCArICcvJyArIGMpO1xuICAgICAgdmFyIGNvdW50ZXIgPSAwO1xuICAgICAgd2hpbGUoIHNvbWVNYXAuaGFzKCBxdWFsaWZpZWQoIGNvdW50ZXIgKSApICkgeyArK2NvdW50ZXI7IH1cbiAgICAgIHJldHVybiBxdWFsaWZpZWQoIGNvdW50ZXIgKTtcbiAgICB9XG4gIH1cblxuICBzZXRQb3J0RWRnZSggZnJvbSwgZWRnZUlkICkge1xuICAgIGNvbnN0IHBvcnRzUGF0aCA9IFsgJ3ZlcnRpY2VzJywgZnJvbS52ZXJ0ZXhJZCwgJ3BvcnRzJywgZnJvbS5kaXJlY3Rpb24gXTtcbiAgICB0aGlzLmdyYXBoID0gdGhpcy5ncmFwaC51cGRhdGVJbiggcG9ydHNQYXRoLCBwb3J0cyA9PiBwb3J0cy5tYXAoIHAgPT5cbiAgICAgIHAuaWQgPT09IGZyb20ucG9ydElkID8gcC5zZXQoICdlZGdlSWQnLCBlZGdlSWQgKSA6IHBcbiAgICApICk7XG4gIH1cblxuICBkaXNjb25uZWN0KCB2ZXJ0ZXgsIHBvcnQgKSB7XG4gICAgY29uc3QgcG9ydHNQYXRoID0gWyAndmVydGljZXMnLCB2ZXJ0ZXguaWQsICdwb3J0cycsIHBvcnQuZGlyZWN0aW9uIF07XG5cbiAgICBjb25zdCB0eXBlID0gdGhpcy50eXBlcy5nZXQoIHBvcnQudHlwZSApO1xuICAgIGlmKCB0eXBlLm93bmluZ1BvcnQgPT09IHBvcnQuZGlyZWN0aW9uICkge1xuICAgICAgdGhpcy5yZW1vdmVFZGdlKCBwb3J0LmVkZ2VJZCApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmdyYXBoO1xuICAgIHRoaXMuZ3JhcGggPSBjdXJyZW50XG4gICAgICAuc2V0SW4oIHBvcnRzUGF0aCwgY3VycmVudC5nZXRJbiggcG9ydHNQYXRoICkubWFwKCBwID0+IHtcbiAgICAgICAgcmV0dXJuIHAuaWQgIT09IHBvcnQuaWQgPyBwIDogcG9ydC5zZXQoICdlZGdlSWQnLCBudWxsICk7XG4gICAgICB9ICkgKTtcbiAgICB0aGlzLnBydW5lRW1wdHlFZGdlcygpO1xuICB9XG5cbiAgcmVtb3ZlRWRnZSggZWRnZUlkICkge1xuICAgIHRoaXMuZGlzY29ubmVjdEFsbCggZWRnZUlkICk7XG4gICAgdGhpcy5wcnVuZUVtcHR5RWRnZXMoKTtcbiAgfVxuXG4gIHJlbW92ZVZlcnRleCggdmVydGV4SWQgKSB7XG4gICAgY29uc3QgdmVydGV4ID0gdGhpcy5ncmFwaC52ZXJ0aWNlcy5nZXQoIHZlcnRleElkICk7XG4gICAgRGlyZWN0aW9ucy5mbGF0TWFwKCBkID0+IHZlcnRleC5wb3J0c1sgZCBdICkuZm9yRWFjaCggcG9ydCA9PiB7XG4gICAgICB0aGlzLmRpc2Nvbm5lY3QoIHZlcnRleCwgcG9ydCApO1xuICAgIH0gKTtcblxuICAgIHRoaXMuZ3JhcGggPSB0aGlzLmdyYXBoLnVwZGF0ZSggJ3ZlcnRpY2VzJywgdnMgPT5cbiAgICAgIHZzLmZpbHRlciggdiA9PiB2LmlkICE9PSB2ZXJ0ZXhJZCApICk7XG4gICAgdGhpcy5wcnVuZUVtcHR5RWRnZXMoKTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3RBbGwoIGVkZ2VJZCApIHtcbiAgICB0aGlzLmdyYXBoID0gbWFwR3JhcGhQb3J0cyggdGhpcy5ncmFwaCwgcCA9PiBwLnNldCggJ2VkZ2VJZCcsXG4gICAgICBwLmVkZ2VJZCA9PT0gZWRnZUlkID8gbnVsbCA6IHAuZWRnZUlkXG4gICAgKSApO1xuICB9XG5cbiAgcHJ1bmVFbXB0eUVkZ2VzKCkge1xuICAgIGNvbnN0IHBvcnRzQnlFZGdlID0gdGhpcy5ncmFwaC52ZXJ0aWNlcy52YWx1ZVNlcSgpXG4gICAgICAuZmxhdE1hcCggdiA9PiBEaXJlY3Rpb25zLmZsYXRNYXAoIGQgPT4gdi5wb3J0c1sgZCBdICkgKVxuICAgICAgLmZpbHRlciggcCA9PiBwLmVkZ2VJZCAhPSBudWxsIClcbiAgICAgIC5ncm91cEJ5KCBwID0+IHAuZWRnZUlkICk7XG5cbiAgICBjb25zdCBpc1NpbXBsZSA9ICggZSApID0+IHRoaXMudHlwZXMuZ2V0KCBlLnR5cGUgKS5vd25pbmdQb3J0ICE9PSBudWxsO1xuXG4gICAgY29uc3QgdG9QcnVuZSA9IHRoaXMuZ3JhcGguZWRnZXMuZmlsdGVyKCBlID0+IHtcbiAgICAgIGNvbnN0IGVkZ2VQb3J0cyA9IHBvcnRzQnlFZGdlLmdldCggZS5pZCApO1xuICAgICAgcmV0dXJuICFlZGdlUG9ydHMgfHwgZWRnZVBvcnRzLnNpemUgPD0gKCBpc1NpbXBsZSggZSApID8gMSA6IDAgKTtcbiAgICB9ICk7XG5cbiAgICB0b1BydW5lLmZvckVhY2goIGUgPT4gdGhpcy5kaXNjb25uZWN0QWxsKCBlLmlkICkgKTtcblxuICAgIHRoaXMuZ3JhcGggPSB0aGlzLmdyYXBoLnNldCggJ2VkZ2VzJyxcbiAgICAgIHRoaXMuZ3JhcGguZWRnZXMuZmlsdGVyKCBlID0+ICF0b1BydW5lLmhhcyggZS5pZCApIClcbiAgICApO1xuICB9XG5cblxuICAvLyBwdXJlIGhlbHBlcnNcblxuICByZW5hbWVSdWxlcyggbmV3R3JhcGggKSB7XG4gICAgcmV0dXJuIE1hcCh7XG4gICAgICBlZGdlczogcmVuYW1lUnVsZXMoIHRoaXMuZ3JhcGguZWRnZXMsIG5ld0dyYXBoLmVkZ2VzICksXG4gICAgICB2ZXJ0aWNlczogcmVuYW1lUnVsZXMoIHRoaXMuZ3JhcGgudmVydGljZXMsIG5ld0dyYXBoLnZlcnRpY2VzIClcbiAgICB9KTtcblxuICAgIGZ1bmN0aW9uIHJlbmFtZVJ1bGVzKCBleGlzdGluZ01hcCwgbmV3TWFwICkge1xuICAgICAgY29uc3QganNFeGlzdGluZ0tleXMgPSBleGlzdGluZ01hcC50b0pTKCk7XG4gICAgICBjb25zdCB0YWtlbktleXMgPSB7fTtcbiAgICAgIGNvbnN0IHJ1bGVzID0ge307XG4gICAgICBuZXdNYXAuZm9yRWFjaCggKF8sIGtleSkgPT4ge1xuICAgICAgICBjb25zdCBuZXdLZXkgPSBkaXNqb2ludEtleShcbiAgICAgICAgICB0YWtlbktleXMsXG4gICAgICAgICAgZGlzam9pbnRLZXkoIGpzRXhpc3RpbmdLZXlzLCBrZXkgKVxuICAgICAgICApO1xuICAgICAgICBydWxlc1sga2V5IF0gPSBuZXdLZXk7XG4gICAgICAgIHRha2VuS2V5c1sgbmV3S2V5IF0gPSB0cnVlO1xuICAgICAgfSApO1xuICAgICAgcmV0dXJuIE1hcCggcnVsZXMgKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBkaXNqb2ludEtleSgganNNYXAsIGtleSApIHtcbiAgICAgIGNvbnN0IG1hdGNoZXIgPSAvXiguKikgKFswLTldKykkLztcbiAgICAgIGlmKCAhanNNYXAuaGFzT3duUHJvcGVydHkoIGtleSApICkge1xuICAgICAgICByZXR1cm4ga2V5O1xuICAgICAgfVxuICAgICAgaWYoICFtYXRjaGVyLnRlc3QoIGtleSApICkge1xuICAgICAgICByZXR1cm4gZGlzam9pbnRLZXkoIGpzTWFwLCBrZXkgKyAnIDEnICk7XG4gICAgICB9XG4gICAgICBjb25zdCBudW1iZXIgPSAxICsgcGFyc2VJbnQoIGtleS5yZXBsYWNlKCBtYXRjaGVyLCAnJDInICksIDEwICk7XG4gICAgICByZXR1cm4gZGlzam9pbnRLZXkoIGpzTWFwLCBrZXkucmVwbGFjZSggbWF0Y2hlciwgJyQxJyApICsgJyAnICsgbnVtYmVyICk7XG4gICAgfVxuICB9XG5cbiAgYXBwbHlSZW5hbWVSdWxlcyggbmV3R3JhcGgsIHJlbmFtZVJ1bGVzICkge1xuICAgIGNvbnN0IGVkZ2VSdWxlcyA9IHJlbmFtZVJ1bGVzLmdldCggJ2VkZ2VzJyApO1xuICAgIGNvbnN0IHZlcnRleFJ1bGVzID0gcmVuYW1lUnVsZXMuZ2V0KCAndmVydGljZXMnICk7XG4gICAgY29uc3QgZWRnZXMgPSB7fTtcbiAgICBuZXdHcmFwaC5lZGdlcy5mb3JFYWNoKCAoZWRnZSwgZUlkKSA9PiB7XG4gICAgICBjb25zdCBuZXdJZCA9IGVkZ2VSdWxlcy5nZXQoIGVJZCApO1xuICAgICAgZWRnZXNbIG5ld0lkIF0gPSBlZGdlLnNldEluKCBbICdpZCcgXSwgbmV3SWQgKTtcbiAgICB9ICk7XG4gICAgY29uc3QgdmVydGljZXMgPSB7fTtcbiAgICBuZXdHcmFwaC52ZXJ0aWNlcy5mb3JFYWNoKCAodmVydGV4LCB2SWQpID0+IHtcbiAgICAgIGNvbnN0IG5ld0lkID0gdmVydGV4UnVsZXMuZ2V0KCB2SWQgKSB8fCB2ZXJ0ZXguaWQ7XG4gICAgICB2ZXJ0aWNlc1sgbmV3SWQgXSA9IHZlcnRleC5zZXRJbiggWyAnaWQnIF0sIG5ld0lkICk7XG4gICAgfSApO1xuICAgIHJldHVybiBtYXBHcmFwaFBvcnRzKFxuICAgICAgR3JhcGgoeyBlZGdlczogTWFwKCBlZGdlcyApLCB2ZXJ0aWNlczogTWFwKCB2ZXJ0aWNlcyApIH0pLFxuICAgICAgcCA9PiBwLnNldCggJ2VkZ2VJZCcsXG4gICAgICAgIHAuZWRnZUlkICYmIGVkZ2VSdWxlcy5nZXQoIHAuZWRnZUlkICkgfHwgcC5lZGdlSWQgfHwgbnVsbFxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBpbnNlcnQoIG5ld0dyYXBoLCByZW5hbWVSdWxlcyApIHtcbiAgICBjb25zdCBkaXNqb2ludEdyYXBoID0gcmVuYW1lUnVsZXMgP1xuICAgICAgdGhpcy5hcHBseVJlbmFtZVJ1bGVzKCBuZXdHcmFwaCwgcmVuYW1lUnVsZXMgKSA6XG4gICAgICBuZXdHcmFwaDtcblxuICAgIHRoaXMuZ3JhcGggPSB0aGlzLmdyYXBoXG4gICAgICAuc2V0KCAnZWRnZXMnLCB0aGlzLmdyYXBoLmVkZ2VzLm1lcmdlKCBkaXNqb2ludEdyYXBoLmVkZ2VzICkgKVxuICAgICAgLnNldCggJ3ZlcnRpY2VzJywgdGhpcy5ncmFwaC52ZXJ0aWNlcy5tZXJnZSggZGlzam9pbnRHcmFwaC52ZXJ0aWNlcyApICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgR3JhcGhTdG9yZTtcblxuXG5mdW5jdGlvbiBtYXBWZXJ0ZXhQb3J0cyggdiwgZiApIHtcbiAgcmV0dXJuIHYuc2V0KCAncG9ydHMnLCBQb3J0cyh7XG4gICAgaW5ib3VuZDogdi5wb3J0cy5pbmJvdW5kLm1hcCggZiApLFxuICAgIG91dGJvdW5kOiB2LnBvcnRzLm91dGJvdW5kLm1hcCggZiApXG4gIH0pICk7XG59XG5cbmZ1bmN0aW9uIG1hcFZlcnRpY2VzKCBncmFwaCwgZiApIHtcbiAgcmV0dXJuIGdyYXBoLnNldEluKCBbICd2ZXJ0aWNlcycgXSwgZ3JhcGgudmVydGljZXMubWFwKCBmICkgKTtcbn1cblxuZnVuY3Rpb24gbWFwR3JhcGhQb3J0cyggZ3JhcGgsIGYgKSB7XG4gIHJldHVybiBtYXBWZXJ0aWNlcyggZ3JhcGgsIHYgPT4gbWFwVmVydGV4UG9ydHMoIHYsIGYgKSApO1xufVxuIl19